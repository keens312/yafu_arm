/*
Copyright (c) 2014, Ben Buhrow and (c) 2022, Jeff Hurchalla.
All rights reserved.
This software is provided "as is," without warranty of any kind,
express or implied.  In no event shall the author or contributors
be held liable for any damages arising in any way from the use of
this software.
The contents of this file are DUAL-LICENSED.  You may modify and/or
redistribute this software according to the terms of one of the
following two licenses (at your option):


LICENSE 1 ("FreeBSD")
---------------------
Copyright (c) 2014, Ben Buhrow and (c) 2022, Jeff Hurchalla.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

The views and conclusions contained in the software and documentation are those
of the authors and should not be interpreted as representing official policies,
either expressed or implied, of the FreeBSD Project.


LICENSE 2 (MPL 2.0)
-------------------
Copyright (c) 2014, Ben Buhrow and (c) 2022, Jeff Hurchalla.
All rights reserved.

This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at https://mozilla.org/MPL/2.0/.
*/


#include "microecm.h"
#include "arith.h"
#include <stddef.h>
#include <stdint.h>
#include <stdlib.h>
#if defined(_MSC_VER)
#  ifndef _WIN64
#    error "64 bit compilation mode is required for MSVC"
#  endif
#  include <immintrin.h>
#  include <intrin.h>
#endif

#include <stdio.h>


#ifdef USE_AVX512F
#  include <immintrin.h>
#endif


// Using the inline asm in this file can increase performance by ~20-25%
// (surprisingly).  Hence these macros are defined by default.
#if defined(__x86_64__) || defined(_M_X64)
#  define MICRO_PM1_ALT_MULREDC_USE_INLINE_ASM_X86
#endif

// We rarely will ever want to use debugging printfs
//#define MICRO_PM1_VERBOSE_PRINTF




#ifdef _MSC_VER
#  define MICRO_PM1_FORCE_INLINE __forceinline
#elif defined(__GNUC__) || defined(__clang__) || defined(__INTEL_COMPILER) || defined (__INTEL_LLVM_COMPILER)
#  define MICRO_PM1_FORCE_INLINE inline __attribute__((always_inline))
#else
#  define MICRO_PM1_FORCE_INLINE __inline
#endif


#ifdef MICRO_PM1_VERBOSE_PRINTF
#  include <stdio.h>
// these globals will cause data races, if we run multithreaded
    uint32_t stg1Doub;
    uint32_t stg1Add;
    uint32_t ptadds;
#endif

static const uint32_t map[60] = {
    0, 1, 2, 0, 0, 0, 0, 3, 0, 0,
    0, 4, 0, 5, 0, 0, 0, 6, 0, 7,
    0, 0, 0, 8, 0, 0, 0, 0, 0, 9,
    0, 10, 0, 0, 0, 0, 0, 11, 0, 0,
    0, 12, 0, 13, 0, 0, 0, 14, 0, 15,
    0, 0, 0, 16, 0, 0, 0, 0, 0, 17 };

static const double INV_2_POW_32 = 1.0 / (double)((uint64_t)(1) << 32);

#define NUMP 2767
static const int primes[NUMP] = {
2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31,
37, 41, 43, 47, 53, 59, 61, 67, 71, 73,
79, 83, 89, 97, 101, 103, 107, 109, 113, 127,
131, 137, 139, 149, 151, 157, 163, 167, 173, 179,
181, 191, 193, 197, 199, 211, 223, 227, 229, 233,
239, 241, 251, 257, 263, 269, 271, 277, 281, 283,
293, 307, 311, 313, 317, 331, 337, 347, 349, 353,
359, 367, 373, 379, 383, 389, 397, 401, 409, 419,
421, 431, 433, 439, 443, 449, 457, 461, 463, 467,
479, 487, 491, 499, 503, 509, 521, 523, 541, 547,
557, 563, 569, 571, 577, 587, 593, 599, 601, 607,
613, 617, 619, 631, 641, 643, 647, 653, 659, 661,
673, 677, 683, 691, 701, 709, 719, 727, 733, 739,
743, 751, 757, 761, 769, 773, 787, 797, 809, 811,
821, 823, 827, 829, 839, 853, 857, 859, 863, 877,
881, 883, 887, 907, 911, 919, 929, 937, 941, 947,
953, 967, 971, 977, 983, 991, 997, 1009, 1013, 1019,
1021, 1031, 1033, 1039, 1049, 1051, 1061, 1063, 1069, 1087,
1091, 1093, 1097, 1103, 1109, 1117, 1123, 1129, 1151, 1153,
1163, 1171, 1181, 1187, 1193, 1201, 1213, 1217, 1223, 1229,
1231, 1237, 1249, 1259, 1277, 1279, 1283, 1289, 1291, 1297,
1301, 1303, 1307, 1319, 1321, 1327, 1361, 1367, 1373, 1381,
1399, 1409, 1423, 1427, 1429, 1433, 1439, 1447, 1451, 1453,
1459, 1471, 1481, 1483, 1487, 1489, 1493, 1499, 1511, 1523,
1531, 1543, 1549, 1553, 1559, 1567, 1571, 1579, 1583, 1597,
1601, 1607, 1609, 1613, 1619, 1621, 1627, 1637, 1657, 1663,
1667, 1669, 1693, 1697, 1699, 1709, 1721, 1723, 1733, 1741,
1747, 1753, 1759, 1777, 1783, 1787, 1789, 1801, 1811, 1823,
1831, 1847, 1861, 1867, 1871, 1873, 1877, 1879, 1889, 1901,
1907, 1913, 1931, 1933, 1949, 1951, 1973, 1979, 1987, 1993,
1997, 1999, 2003, 2011, 2017, 2027, 2029, 2039, 2053, 2063,
2069, 2081, 2083, 2087, 2089, 2099, 2111, 2113, 2129, 2131,
2137, 2141, 2143, 2153, 2161, 2179, 2203, 2207, 2213, 2221,
2237, 2239, 2243, 2251, 2267, 2269, 2273, 2281, 2287, 2293,
2297, 2309, 2311, 2333, 2339, 2341, 2347, 2351, 2357, 2371,
2377, 2381, 2383, 2389, 2393, 2399, 2411, 2417, 2423, 2437,
2441, 2447, 2459, 2467, 2473, 2477, 2503, 2521, 2531, 2539,
2543, 2549, 2551, 2557, 2579, 2591, 2593, 2609, 2617, 2621,
2633, 2647, 2657, 2659, 2663, 2671, 2677, 2683, 2687, 2689,
2693, 2699, 2707, 2711, 2713, 2719, 2729, 2731, 2741, 2749,
2753, 2767, 2777, 2789, 2791, 2797, 2801, 2803, 2819, 2833,
2837, 2843, 2851, 2857, 2861, 2879, 2887, 2897, 2903, 2909,
2917, 2927, 2939, 2953, 2957, 2963, 2969, 2971, 2999, 3001,
3011, 3019, 3023, 3037, 3041, 3049, 3061, 3067, 3079, 3083,
3089, 3109, 3119, 3121, 3137, 3163, 3167, 3169, 3181, 3187,
3191, 3203, 3209, 3217, 3221, 3229, 3251, 3253, 3257, 3259,
3271, 3299, 3301, 3307, 3313, 3319, 3323, 3329, 3331, 3343,
3347, 3359, 3361, 3371, 3373, 3389, 3391, 3407, 3413, 3433,
3449, 3457, 3461, 3463, 3467, 3469, 3491, 3499, 3511, 3517,
3527, 3529, 3533, 3539, 3541, 3547, 3557, 3559, 3571, 3581,
3583, 3593, 3607, 3613, 3617, 3623, 3631, 3637, 3643, 3659,
3671, 3673, 3677, 3691, 3697, 3701, 3709, 3719, 3727, 3733,
3739, 3761, 3767, 3769, 3779, 3793, 3797, 3803, 3821, 3823,
3833, 3847, 3851, 3853, 3863, 3877, 3881, 3889, 3907, 3911,
3917, 3919, 3923, 3929, 3931, 3943, 3947, 3967, 3989, 4001,
4003, 4007, 4013, 4019, 4021, 4027, 4049, 4051, 4057, 4073,
4079, 4091, 4093, 4099, 4111, 4127, 4129, 4133, 4139, 4153,
4157, 4159, 4177, 4201, 4211, 4217, 4219, 4229, 4231, 4241,
4243, 4253, 4259, 4261, 4271, 4273, 4283, 4289, 4297, 4327,
4337, 4339, 4349, 4357, 4363, 4373, 4391, 4397, 4409, 4421,
4423, 4441, 4447, 4451, 4457, 4463, 4481, 4483, 4493, 4507,
4513, 4517, 4519, 4523, 4547, 4549, 4561, 4567, 4583, 4591,
4597, 4603, 4621, 4637, 4639, 4643, 4649, 4651, 4657, 4663,
4673, 4679, 4691, 4703, 4721, 4723, 4729, 4733, 4751, 4759,
4783, 4787, 4789, 4793, 4799, 4801, 4813, 4817, 4831, 4861,
4871, 4877, 4889, 4903, 4909, 4919, 4931, 4933, 4937, 4943,
4951, 4957, 4967, 4969, 4973, 4987, 4993, 4999, 5003, 5009,
5011, 5021, 5023, 5039, 5051, 5059, 5077, 5081, 5087, 5099,
5101, 5107, 5113, 5119, 5147, 5153, 5167, 5171, 5179, 5189,
5197, 5209, 5227, 5231, 5233, 5237, 5261, 5273, 5279, 5281,
5297, 5303, 5309, 5323, 5333, 5347, 5351, 5381, 5387, 5393,
5399, 5407, 5413, 5417, 5419, 5431, 5437, 5441, 5443, 5449,
5471, 5477, 5479, 5483, 5501, 5503, 5507, 5519, 5521, 5527,
5531, 5557, 5563, 5569, 5573, 5581, 5591, 5623, 5639, 5641,
5647, 5651, 5653, 5657, 5659, 5669, 5683, 5689, 5693, 5701,
5711, 5717, 5737, 5741, 5743, 5749, 5779, 5783, 5791, 5801,
5807, 5813, 5821, 5827, 5839, 5843, 5849, 5851, 5857, 5861,
5867, 5869, 5879, 5881, 5897, 5903, 5923, 5927, 5939, 5953,
5981, 5987, 6007, 6011, 6029, 6037, 6043, 6047, 6053, 6067,
6073, 6079, 6089, 6091, 6101, 6113, 6121, 6131, 6133, 6143,
6151, 6163, 6173, 6197, 6199, 6203, 6211, 6217, 6221, 6229,
6247, 6257, 6263, 6269, 6271, 6277, 6287, 6299, 6301, 6311,
6317, 6323, 6329, 6337, 6343, 6353, 6359, 6361, 6367, 6373,
6379, 6389, 6397, 6421, 6427, 6449, 6451, 6469, 6473, 6481,
6491, 6521, 6529, 6547, 6551, 6553, 6563, 6569, 6571, 6577,
6581, 6599, 6607, 6619, 6637, 6653, 6659, 6661, 6673, 6679,
6689, 6691, 6701, 6703, 6709, 6719, 6733, 6737, 6761, 6763,
6779, 6781, 6791, 6793, 6803, 6823, 6827, 6829, 6833, 6841,
6857, 6863, 6869, 6871, 6883, 6899, 6907, 6911, 6917, 6947,
6949, 6959, 6961, 6967, 6971, 6977, 6983, 6991, 6997, 7001,
7013, 7019, 7027, 7039, 7043, 7057, 7069, 7079, 7103, 7109,
7121, 7127, 7129, 7151, 7159, 7177, 7187, 7193, 7207, 7211,
7213, 7219, 7229, 7237, 7243, 7247, 7253, 7283, 7297, 7307,
7309, 7321, 7331, 7333, 7349, 7351, 7369, 7393, 7411, 7417,
7433, 7451, 7457, 7459, 7477, 7481, 7487, 7489, 7499, 7507,
7517, 7523, 7529, 7537, 7541, 7547, 7549, 7559, 7561, 7573,
7577, 7583, 7589, 7591, 7603, 7607, 7621, 7639, 7643, 7649,
7669, 7673, 7681, 7687, 7691, 7699, 7703, 7717, 7723, 7727,
7741, 7753, 7757, 7759, 7789, 7793, 7817, 7823, 7829, 7841,
7853, 7867, 7873, 7877, 7879, 7883, 7901, 7907, 7919, 7927,
7933, 7937, 7949, 7951, 7963, 7993, 8009, 8011, 8017, 8039,
8053, 8059, 8069, 8081, 8087, 8089, 8093, 8101, 8111, 8117,
8123, 8147, 8161, 8167, 8171, 8179, 8191, 8209, 8219, 8221,
8231, 8233, 8237, 8243, 8263, 8269, 8273, 8287, 8291, 8293,
8297, 8311, 8317, 8329, 8353, 8363, 8369, 8377, 8387, 8389,
8419, 8423, 8429, 8431, 8443, 8447, 8461, 8467, 8501, 8513,
8521, 8527, 8537, 8539, 8543, 8563, 8573, 8581, 8597, 8599,
8609, 8623, 8627, 8629, 8641, 8647, 8663, 8669, 8677, 8681,
8689, 8693, 8699, 8707, 8713, 8719, 8731, 8737, 8741, 8747,
8753, 8761, 8779, 8783, 8803, 8807, 8819, 8821, 8831, 8837,
8839, 8849, 8861, 8863, 8867, 8887, 8893, 8923, 8929, 8933,
8941, 8951, 8963, 8969, 8971, 8999, 9001, 9007, 9011, 9013,
9029, 9041, 9043, 9049, 9059, 9067, 9091, 9103, 9109, 9127,
9133, 9137, 9151, 9157, 9161, 9173, 9181, 9187, 9199, 9203,
9209, 9221, 9227, 9239, 9241, 9257, 9277, 9281, 9283, 9293,
9311, 9319, 9323, 9337, 9341, 9343, 9349, 9371, 9377, 9391,
9397, 9403, 9413, 9419, 9421, 9431, 9433, 9437, 9439, 9461,
9463, 9467, 9473, 9479, 9491, 9497, 9511, 9521, 9533, 9539,
9547, 9551, 9587, 9601, 9613, 9619, 9623, 9629, 9631, 9643,
9649, 9661, 9677, 9679, 9689, 9697, 9719, 9721, 9733, 9739,
9743, 9749, 9767, 9769, 9781, 9787, 9791, 9803, 9811, 9817,
9829, 9833, 9839, 9851, 9857, 9859, 9871, 9883, 9887, 9901,
9907, 9923, 9929, 9931, 9941, 9949, 9967, 9973, 10007, 10009,
10037, 10039, 10061, 10067, 10069, 10079, 10091, 10093, 10099, 10103, 10111,
10133, 10139, 10141, 10151, 10159, 10163, 10169, 10177, 10181, 10193, 10211,
10223, 10243, 10247, 10253, 10259, 10267, 10271, 10273, 10289, 10301, 10303,
10313, 10321, 10331, 10333, 10337, 10343, 10357, 10369, 10391, 10399, 10427,
10429, 10433, 10453, 10457, 10459, 10463, 10477, 10487, 10499, 10501, 10513,
10529, 10531, 10559, 10567, 10589, 10597, 10601, 10607, 10613, 10627, 10631,
10639, 10651, 10657, 10663, 10667, 10687, 10691, 10709, 10711, 10723, 10729,
10733, 10739, 10753, 10771, 10781, 10789, 10799, 10831, 10837, 10847, 10853,
10859, 10861, 10867, 10883, 10889, 10891, 10903, 10909, 10937, 10939, 10949,
10957, 10973, 10979, 10987, 10993, 11003, 11027, 11047, 11057, 11059, 11069,
11071, 11083, 11087, 11093, 11113, 11117, 11119, 11131, 11149, 11159, 11161,
11171, 11173, 11177, 11197, 11213, 11239, 11243, 11251, 11257, 11261, 11273,
11279, 11287, 11299, 11311, 11317, 11321, 11329, 11351, 11353, 11369, 11383,
11393, 11399, 11411, 11423, 11437, 11443, 11447, 11467, 11471, 11483, 11489,
11491, 11497, 11503, 11519, 11527, 11549, 11551, 11579, 11587, 11593, 11597,
11617, 11621, 11633, 11657, 11677, 11681, 11689, 11699, 11701, 11717, 11719,
11731, 11743, 11777, 11779, 11783, 11789, 11801, 11807, 11813, 11821, 11827,
11831, 11833, 11839, 11863, 11867, 11887, 11897, 11903, 11909, 11923, 11927,
11933, 11939, 11941, 11953, 11959, 11969, 11971, 11981, 11987, 12007, 12011,
12037, 12041, 12043, 12049, 12071, 12073, 12097, 12101, 12107, 12109, 12113, 12119, 12143, 12149, 12157, 12161,
12163, 12197, 12203, 12211, 12227, 12239, 12241, 12251, 12253, 12263, 12269, 12277, 12281, 12289, 12301, 12323,
12329, 12343, 12347, 12373, 12377, 12379, 12391, 12401, 12409, 12413, 12421, 12433, 12437, 12451, 12457, 12473,
12479, 12487, 12491, 12497, 12503, 12511, 12517, 12527, 12539, 12541, 12547, 12553, 12569, 12577, 12583, 12589,
12601, 12611, 12613, 12619, 12637, 12641, 12647, 12653, 12659, 12671, 12689, 12697, 12703, 12713, 12721, 12739,
12743, 12757, 12763, 12781, 12791, 12799, 12809, 12821, 12823, 12829, 12841, 12853, 12889, 12893, 12899, 12907,
12911, 12917, 12919, 12923, 12941, 12953, 12959, 12967, 12973, 12979, 12983, 13001, 13003, 13007, 13009, 13033,
13037, 13043, 13049, 13063, 13093, 13099, 13103, 13109, 13121, 13127, 13147, 13151, 13159, 13163, 13171, 13177,
13183, 13187, 13217, 13219, 13229, 13241, 13249, 13259, 13267, 13291, 13297, 13309, 13313, 13327, 13331, 13337,
13339, 13367, 13381, 13397, 13399, 13411, 13417, 13421, 13441, 13451, 13457, 13463, 13469, 13477, 13487, 13499,
13513, 13523, 13537, 13553, 13567, 13577, 13591, 13597, 13613, 13619, 13627, 13633, 13649, 13669, 13679, 13681,
13687, 13691, 13693, 13697, 13709, 13711, 13721, 13723, 13729, 13751, 13757, 13759, 13763, 13781, 13789, 13799,
13807, 13829, 13831, 13841, 13859, 13873, 13877, 13879, 13883, 13901, 13903, 13907, 13913, 13921, 13931, 13933,
13963, 13967, 13997, 13999, 14009, 14011, 14029, 14033, 14051, 14057, 14071, 14081, 14083, 14087, 14107, 14143,
14149, 14153, 14159, 14173, 14177, 14197, 14207, 14221, 14243, 14249, 14251, 14281, 14293, 14303, 14321, 14323,
14327, 14341, 14347, 14369, 14387, 14389, 14401, 14407, 14411, 14419, 14423, 14431, 14437, 14447, 14449, 14461,
14479, 14489, 14503, 14519, 14533, 14537, 14543, 14549, 14551, 14557, 14561, 14563, 14591, 14593, 14621, 14627,
14629, 14633, 14639, 14653, 14657, 14669, 14683, 14699, 14713, 14717, 14723, 14731, 14737, 14741, 14747, 14753,
14759, 14767, 14771, 14779, 14783, 14797, 14813, 14821, 14827, 14831, 14843, 14851, 14867, 14869, 14879, 14887,
14891, 14897, 14923, 14929, 14939, 14947, 14951, 14957, 14969, 14983, 15013, 15017, 15031, 15053, 15061, 15073,
15077, 15083, 15091, 15101, 15107, 15121, 15131, 15137, 15139, 15149, 15161, 15173, 15187, 15193, 15199, 15217,
15227, 15233, 15241, 15259, 15263, 15269, 15271, 15277, 15287, 15289, 15299, 15307, 15313, 15319, 15329, 15331,
15349, 15359, 15361, 15373, 15377, 15383, 15391, 15401, 15413, 15427, 15439, 15443, 15451, 15461, 15467, 15473,
15493, 15497, 15511, 15527, 15541, 15551, 15559, 15569, 15581, 15583, 15601, 15607, 15619, 15629, 15641, 15643,
15647, 15649, 15661, 15667, 15671, 15679, 15683, 15727, 15731, 15733, 15737, 15739, 15749, 15761, 15767, 15773,
15787, 15791, 15797, 15803, 15809, 15817, 15823, 15859, 15877, 15881, 15887, 15889, 15901, 15907, 15913, 15919,
15923, 15937, 15959, 15971, 15973, 15991, 16001, 16007, 16033, 16057, 16061, 16063, 16067, 16069, 16073, 16087,
16091, 16097, 16103, 16111, 16127, 16139, 16141, 16183, 16187, 16189, 16193, 16217, 16223, 16229, 16231, 16249,
16253, 16267, 16273, 16301, 16319, 16333, 16339, 16349, 16361, 16363, 16369, 16381, 16411, 16417, 16421, 16427,
16433, 16447, 16451, 16453, 16477, 16481, 16487, 16493, 16519, 16529, 16547, 16553, 16561, 16567, 16573, 16603,
16607, 16619, 16631, 16633, 16649, 16651, 16657, 16661, 16673, 16691, 16693, 16699, 16703, 16729, 16741, 16747,
16759, 16763, 16787, 16811, 16823, 16829, 16831, 16843, 16871, 16879, 16883, 16889, 16901, 16903, 16921, 16927,
16931, 16937, 16943, 16963, 16979, 16981, 16987, 16993, 17011, 17021, 17027, 17029, 17033, 17041, 17047, 17053,
17077, 17093, 17099, 17107, 17117, 17123, 17137, 17159, 17167, 17183, 17189, 17191, 17203, 17207, 17209, 17231,
17239, 17257, 17291, 17293, 17299, 17317, 17321, 17327, 17333, 17341, 17351, 17359, 17377, 17383, 17387, 17389,
17393, 17401, 17417, 17419, 17431, 17443, 17449, 17467, 17471, 17477, 17483, 17489, 17491, 17497, 17509, 17519,
17539, 17551, 17569, 17573, 17579, 17581, 17597, 17599, 17609, 17623, 17627, 17657, 17659, 17669, 17681, 17683,
17707, 17713, 17729, 17737, 17747, 17749, 17761, 17783, 17789, 17791, 17807, 17827, 17837, 17839, 17851, 17863,
17881, 17891, 17903, 17909, 17911, 17921, 17923, 17929, 17939, 17957, 17959, 17971, 17977, 17981, 17987, 17989,
18013, 18041, 18043, 18047, 18049, 18059, 18061, 18077, 18089, 18097, 18119, 18121, 18127, 18131, 18133, 18143,
18149, 18169, 18181, 18191, 18199, 18211, 18217, 18223, 18229, 18233, 18251, 18253, 18257, 18269, 18287, 18289,
18301, 18307, 18311, 18313, 18329, 18341, 18353, 18367, 18371, 18379, 18397, 18401, 18413, 18427, 18433, 18439,
18443, 18451, 18457, 18461, 18481, 18493, 18503, 18517, 18521, 18523, 18539, 18541, 18553, 18583, 18587, 18593,
18617, 18637, 18661, 18671, 18679, 18691, 18701, 18713, 18719, 18731, 18743, 18749, 18757, 18773, 18787, 18793,
18797, 18803, 18839, 18859, 18869, 18899, 18911, 18913, 18917, 18919, 18947, 18959, 18973, 18979, 19001, 19009,
19013, 19031, 19037, 19051, 19069, 19073, 19079, 19081, 19087, 19121, 19139, 19141, 19157, 19163, 19181, 19183,
19207, 19211, 19213, 19219, 19231, 19237, 19249, 19259, 19267, 19273, 19289, 19301, 19309, 19319, 19333, 19373,
19379, 19381, 19387, 19391, 19403, 19417, 19421, 19423, 19427, 19429, 19433, 19441, 19447, 19457, 19463, 19469,
19471, 19477, 19483, 19489, 19501, 19507, 19531, 19541, 19543, 19553, 19559, 19571, 19577, 19583, 19597, 19603,
19609, 19661, 19681, 19687, 19697, 19699, 19709, 19717, 19727, 19739, 19751, 19753, 19759, 19763, 19777, 19793,
19801, 19813, 19819, 19841, 19843, 19853, 19861, 19867, 19889, 19891, 19913, 19919, 19927, 19937, 19949, 19961,
19963, 19973, 19979, 19991, 19993, 19997, 20011, 20021, 20023, 20029, 20047, 20051, 20063, 20071, 20089, 20101,
20107, 20113, 20117, 20123, 20129, 20143, 20147, 20149, 20161, 20173, 20177, 20183, 20201, 20219, 20231, 20233,
20249, 20261, 20269, 20287, 20297, 20323, 20327, 20333, 20341, 20347, 20353, 20357, 20359, 20369, 20389, 20393,
20399, 20407, 20411, 20431, 20441, 20443, 20477, 20479, 20483, 20507, 20509, 20521, 20533, 20543, 20549, 20551,
20563, 20593, 20599, 20611, 20627, 20639, 20641, 20663, 20681, 20693, 20707, 20717, 20719, 20731, 20743, 20747,
20749, 20753, 20759, 20771, 20773, 20789, 20807, 20809, 20849, 20857, 20873, 20879, 20887, 20897, 20899, 20903,
20921, 20929, 20939, 20947, 20959, 20963, 20981, 20983, 21001, 21011, 21013, 21017, 21019, 21023, 21031, 21059,
21061, 21067, 21089, 21101, 21107, 21121, 21139, 21143, 21149, 21157, 21163, 21169, 21179, 21187, 21191, 21193,
21211, 21221, 21227, 21247, 21269, 21277, 21283, 21313, 21317, 21319, 21323, 21341, 21347, 21377, 21379, 21383,
21391, 21397, 21401, 21407, 21419, 21433, 21467, 21481, 21487, 21491, 21493, 21499, 21503, 21517, 21521, 21523,
21529, 21557, 21559, 21563, 21569, 21577, 21587, 21589, 21599, 21601, 21611, 21613, 21617, 21647, 21649, 21661,
21673, 21683, 21701, 21713, 21727, 21737, 21739, 21751, 21757, 21767, 21773, 21787, 21799, 21803, 21817, 21821,
21839, 21841, 21851, 21859, 21863, 21871, 21881, 21893, 21911, 21929, 21937, 21943, 21961, 21977, 21991, 21997,
22003, 22013, 22027, 22031, 22037, 22039, 22051, 22063, 22067, 22073, 22079, 22091, 22093, 22109, 22111, 22123,
22129, 22133, 22147, 22153, 22157, 22159, 22171, 22189, 22193, 22229, 22247, 22259, 22271, 22273, 22277, 22279,
22283, 22291, 22303, 22307, 22343, 22349, 22367, 22369, 22381, 22391, 22397, 22409, 22433, 22441, 22447, 22453,
22469, 22481, 22483, 22501, 22511, 22531, 22541, 22543, 22549, 22567, 22571, 22573, 22613, 22619, 22621, 22637,
22639, 22643, 22651, 22669, 22679, 22691, 22697, 22699, 22709, 22717, 22721, 22727, 22739, 22741, 22751, 22769,
22777, 22783, 22787, 22807, 22811, 22817, 22853, 22859, 22861, 22871, 22877, 22901, 22907, 22921, 22937, 22943,
22961, 22963, 22973, 22993, 23003, 23011, 23017, 23021, 23027, 23029, 23039, 23041, 23053, 23057, 23059, 23063,
23071, 23081, 23087, 23099, 23117, 23131, 23143, 23159, 23167, 23173, 23189, 23197, 23201, 23203, 23209, 23227,
23251, 23269, 23279, 23291, 23293, 23297, 23311, 23321, 23327, 23333, 23339, 23357, 23369, 23371, 23399, 23417,
23431, 23447, 23459, 23473, 23497, 23509, 23531, 23537, 23539, 23549, 23557, 23561, 23563, 23567, 23581, 23593,
23599, 23603, 23609, 23623, 23627, 23629, 23633, 23663, 23669, 23671, 23677, 23687, 23689, 23719, 23741, 23743,
23747, 23753, 23761, 23767, 23773, 23789, 23801, 23813, 23819, 23827, 23831, 23833, 23857, 23869, 23873, 23879,
23887, 23893, 23899, 23909, 23911, 23917, 23929, 23957, 23971, 23977, 23981, 23993, 24001, 24007, 24019, 24023,
24029, 24043, 24049, 24061, 24071, 24077, 24083, 24091, 24097, 24103, 24107, 24109, 24113, 24121, 24133, 24137,
24151, 24169, 24179, 24181, 24197, 24203, 24223, 24229, 24239, 24247, 24251, 24281, 24317, 24329, 24337, 24359,
24371, 24373, 24379, 24391, 24407, 24413, 24419, 24421, 24439, 24443, 24469, 24473, 24481, 24499, 24509, 24517,
24527, 24533, 24547, 24551, 24571, 24593, 24611, 24623, 24631, 24659, 24671, 24677, 24683, 24691, 24697, 24709,
24733, 24749, 24763, 24767, 24781, 24793, 24799, 24809, 24821, 24841, 24847, 24851, 24859, 24877, 24889, 24907,
24917, 24919, 24923, 24943, 24953, 24967, 24971, 24977, 24979, 24989, 25013, 25031, 25033, 25037, 25057};


static uint32_t upm1_lcg_rand_32B(uint32_t lower, uint32_t upper, uint64_t *ploc_lcg)
{
    *ploc_lcg = 6364136223846793005ULL * (*ploc_lcg) + 1442695040888963407ULL;
    return lower + (uint32_t)(
        (double)(upper - lower) * (double)((*ploc_lcg) >> 32) * INV_2_POW_32);
}

__inline uint64_t upm1_submod(uint64_t a, uint64_t b, uint64_t n);
__inline uint64_t upm1_addmod(uint64_t a, uint64_t b, uint64_t n);

#if 0// defined(MICRO_PM1_ALT_MULREDC_USE_INLINE_ASM_X86) && !defined(_MSC_VER)

MICRO_PM1_FORCE_INLINE uint64_t upm1_submod(uint64_t a, uint64_t b, uint64_t n)
{
    __asm__(
        "xorq %%r8, %%r8 \n\t"
        "subq %1, %0 \n\t"
        "cmovc %2, %%r8 \n\t"
        "addq %%r8, %0 \n\t"
        : "+r"(a)
        : "r"(b), "r"(n)
        : "r8", "cc");

    return a;
}

MICRO_PM1_FORCE_INLINE uint64_t upm1_addmod(uint64_t x, uint64_t y, uint64_t n)
{
    uint64_t t = x - n;
    x += y;
    __asm__("add %2, %1\n\t"
        "cmovc %1, %0\n\t"
        :"+r" (x), "+&r" (t)
        : "r" (y)
        : "cc"
    );
    return x;
}

#else

MICRO_PM1_FORCE_INLINE uint64_t upm1_submod(uint64_t a, uint64_t b, uint64_t n)
{
    uint64_t r0;
    if (_subborrow_u64(0, a, b, &r0))
        r0 += n;
    return r0;
}

MICRO_PM1_FORCE_INLINE uint64_t upm1_addmod(uint64_t x, uint64_t y, uint64_t n)
{
#if 0
    uint64_t r;
    uint64_t tmp = x - n;
    uint8_t c = _addcarry_u64(0, tmp, y, &r);
    return (c) ? r : x + y;
#else
    // FYI: The clause above often compiles with a branch in MSVC.
    // The statement below often compiles without a branch (uses cmov) in MSVC.
    return (x >= n - y) ? x - (n - y) : x + y;
#endif
}

#endif

/* --- The following two functions are written by Jeff Hurchalla, Copyright 2022 --- */

// for this algorithm, see https://jeffhurchalla.com/2022/04/28/montgomery-redc-using-the-positive-inverse-mod-r/
MICRO_PM1_FORCE_INLINE static uint64_t upm1_mulredc_alt(uint64_t x, uint64_t y, uint64_t N, uint64_t invN)
{
#if defined(_MSC_VER)
    uint64_t T_hi;
    uint64_t T_lo = _umul128(x, y, &T_hi);
    uint64_t m = T_lo * invN;
    uint64_t mN_hi = __umulh(m, N);
#else
    __uint128_t prod = (__uint128_t)x * y;
    uint64_t T_hi = (uint64_t)(prod >> 64);
    uint64_t T_lo = (uint64_t)(prod);
    uint64_t m = T_lo * invN;
    __uint128_t mN = (__uint128_t)m * N;
    uint64_t mN_hi = (uint64_t)(mN >> 64);
#endif
    uint64_t tmp = T_hi + N;
#if 0//defined(MICRO_PM1_ALT_MULREDC_USE_INLINE_ASM_X86) && !defined(_MSC_VER)
    __asm__ (
        "subq %[mN_hi], %[tmp] \n\t"    /* tmp = T_hi + N - mN_hi */
        "subq %[mN_hi], %[T_hi] \n\t"   /* T_hi = T_hi - mN_hi */
        "cmovaeq %[T_hi], %[tmp] \n\t"  /* tmp = (T_hi >= mN_hi) ? T_hi : tmp */
        : [tmp]"+&r"(tmp), [T_hi]"+&r"(T_hi)
        : [mN_hi]"r"(mN_hi)
        : "cc");
    uint64_t result = tmp;
#else
    tmp = tmp - mN_hi;
    uint64_t result = T_hi - mN_hi;
    result = (T_hi < mN_hi) ? tmp : result;
#endif
   return result;
}

// for this algorithm, see https://jeffhurchalla.com/2022/04/25/a-faster-multiplicative-inverse-mod-a-power-of-2/
static uint64_t upm1_multiplicative_inverse(uint64_t a)
{
//    assert(a%2 == 1);  // the inverse (mod 2<<64) only exists for odd values
    uint64_t x0 = (3*a)^2;
    uint64_t y = 1 - a*x0;
    uint64_t x1 = x0*(1 + y);
    y *= y;
    uint64_t x2 = x1*(1 + y);
    y *= y;
    uint64_t x3 = x2*(1 + y);
    y *= y;
    uint64_t x4 = x3*(1 + y);
    return x4;
}

static uint64_t upm1_bingcd64(uint64_t u, uint64_t v)
{
#if 1
    if (u == 0) {
        return v;
    }
    if (v != 0) {
        int j = _trail_zcnt64(v);
        v = (uint64_t)(v >> j);
        while (1) {
            uint64_t tmp = u;
            uint64_t sub1 = (uint64_t)(v - tmp);
            uint64_t sub2 = (uint64_t)(tmp - v);
            if (tmp == v)
                break;
            u = (tmp >= v) ? v : tmp;
            v = (tmp >= v) ? sub2 : sub1;
            // For the line below, the standard way to write this algorithm
            // would have been to use _trail_zcnt64(v)  (instead of
            // _trail_zcnt64(sub1)).  However, as pointed out by
            // https://gmplib.org/manual/Binary-GCD, "in twos complement the
            // number of low zero bits on u-v is the same as v-u, so counting or
            // testing can begin on u-v without waiting for abs(u-v) to be
            // determined."  Hence we are able to use sub1 for the argument.
            // By removing the dependency on abs(u-v), the CPU can execute
            // _trail_zcnt64() at the same time as abs(u-v).
            j = _trail_zcnt64(sub1);
            v = (uint64_t)(v >> j);
        }
    }
    return u;
#else
    // For reference, or if in the future we need to allow an even u,
    // this version allows u to be even or odd.
    if (u == 0) {
        return v;
    }
    if (v != 0) {
        int i = _trail_zcnt64(u);
        int j = _trail_zcnt64(v);
        u = (uint64_t)(u >> i);
        v = (uint64_t)(v >> j);
        int k = (i < j) ? i : j;
        while (1) {
            uint64_t tmp = u;
            uint64_t sub1 = (uint64_t)(v - tmp);
            uint64_t sub2 = (uint64_t)(tmp - v);
            if (tmp == v)
                break;
            u = (tmp >= v) ? v : tmp;
            v = (tmp >= v) ? sub2 : sub1;
            // For the line below, the standard way to write this algorithm
            // would have been to use _trail_zcnt64(v)  (instead of
            // _trail_zcnt64(sub1)).  However, as pointed out by
            // https://gmplib.org/manual/Binary-GCD, "in twos complement the
            // number of low zero bits on u-v is the same as v-u, so counting or
            // testing can begin on u-v without waiting for abs(u-v) to be
            // determined."  Hence we are able to use sub1 for the argument.
            // By removing the dependency on abs(u-v), the CPU can execute
            // _trail_zcnt64() at the same time as abs(u-v).
            j = _trail_zcnt64(sub1);
            v = (uint64_t)(v >> j);
        }
        u = (uint64_t)(u << k);
    }
    return u;
#endif
}

/* --- end Hurchalla functions --- */


// full strength mul/sqr redc
MICRO_PM1_FORCE_INLINE static uint64_t upm1_mulredc(uint64_t x, uint64_t y, uint64_t n, uint64_t nhat)
{
    return upm1_mulredc_alt(x, y, n, 0 - nhat);
}
MICRO_PM1_FORCE_INLINE static uint64_t upm1_sqrredc(uint64_t x, uint64_t n, uint64_t nhat)
{
    return upm1_mulredc_alt(x, x, n, 0 - nhat);
}

static int upm1_check_factor(uint64_t Z, uint64_t n, uint64_t* f)
{
    int status = 0;
    *f = upm1_bingcd64(n, Z);

    if (*f > 1)
    {
        if (*f == n)
        {
            *f = 0;
            status = 0;
        }
        else
        {
            status = 1;
        }
    }
    return status;
}

static int ewin33[12] = { 8, 3, 5, 5, 9, 2, 7, 9, 7, 10, 10, 0 };
static int ewin100[34] = { // 170 muls
        12, 12, 14, 3, 12, 7, 13, 6, 12, 0, 15, 4, 1, 8, 7, 3, 0, 14, 13, 6, 
        5, 6, 15, 13, 0, 11, 0, 14, 13, 3, 8, 8, 12, 0 };
static int ewin333[119] = { // 595 muls
    2, 5, 1, 6, 12, 5, 1, 5, 0, 15, 3, 13, 2, 4, 2, 0, 4, 13, 11, 9, 4, 5, 
    4, 13, 7, 15, 0, 11, 10, 7, 5, 4, 7, 0, 14, 11, 12, 10, 12, 4, 11, 2, 
    5, 2, 10, 10, 7, 3, 14, 11, 8, 0, 15, 2, 2, 3, 10, 11, 6, 9, 2, 8, 15, 
    4, 12, 13, 14, 13, 0, 7, 3, 3, 12, 3, 9, 8, 4, 6, 15, 0, 3, 9, 11, 14, 
    5, 7, 4, 4, 11, 14, 8, 6, 11, 14, 0, 12, 13, 4, 12, 12, 11, 6, 13, 0, 
    10, 8, 13, 6, 13, 15, 2, 5, 14, 13, 11, 11, 15, 0, 0 };
static int ewin666[243] = { // 1215 muls
    6, 15, 12, 1, 15, 8, 2, 2, 13, 7, 9, 2, 13, 0, 6, 10, 14, 1, 4, 14, 0, 
    10, 9, 6, 0, 9, 11, 0, 11, 2, 5, 5, 12, 14, 9, 11, 7, 11, 7, 9, 2, 1, 1, 
    2, 1, 9, 14, 3, 3, 1, 0, 2, 12, 15, 0, 10, 11, 14, 10, 9, 11, 0, 13, 6, 
    5, 10, 7, 14, 7, 4, 5, 3, 11, 15, 0, 9, 1, 2, 12, 13, 0, 9, 6, 10, 14, 0, 
    11, 8, 7, 4, 15, 10, 10, 6, 8, 11, 9, 8, 1, 2, 7, 4, 0, 9, 6, 7, 11, 6, 
    14, 0, 1, 12, 8, 11, 13, 5, 4, 0, 13, 14, 2, 0, 8, 12, 2, 8, 3, 10, 14, 11, 
    0, 15, 7, 9, 1, 7, 10, 3, 8, 11, 9, 8, 10, 9, 6, 0, 1, 13, 2, 8, 14, 0, 8, 
    13, 0, 0, 6, 13, 5, 15, 4, 6, 3, 0, 8, 15, 3, 14, 12, 11, 5, 6, 14, 1, 4, 
    6, 9, 14, 1, 0, 3, 15, 6, 8, 0, 0, 8, 4, 10, 0, 1, 9, 9, 15, 14, 14, 8, 
    12, 14, 14, 13, 8, 6, 7, 6, 11, 9, 6, 7, 7, 6, 8, 15, 1, 15, 2, 13, 9, 5, 
    7, 10, 10, 11, 11, 2, 15, 4, 3, 10, 6, 9, 2, 14, 8, 14, 5, 6, 2, 15, 12, 
    10, 0, 0 };
static int ewin1000[360] = { // 1800 muls
    3, 11, 15, 13, 0, 1, 12, 9, 9, 13, 3, 2, 15, 9, 11, 15, 2, 13, 7, 4, 7, 8, 
    10, 1, 3, 7, 10, 11, 3, 9, 12, 4, 14, 5, 7, 0, 14, 9, 6, 0, 0, 12, 1, 10, 
    3, 8, 6, 1, 4, 3, 12, 15, 5, 11, 14, 14, 5, 1, 4, 2, 9, 2, 0, 7, 7, 14, 2, 
    12, 10, 3, 4, 0, 10, 9, 2, 2, 3, 2, 4, 2, 3, 12, 5, 11, 7, 11, 0, 14, 2, 
    4, 2, 7, 11, 3, 5, 1, 6, 10, 0, 2, 1, 11, 0, 10, 11, 4, 10, 0, 1, 7, 14, 1, 
    14, 7, 2, 5, 0, 6, 12, 0, 7, 15, 1, 12, 15, 15, 6, 1, 5, 13, 0, 12, 4, 8, 
    12, 8, 13, 14, 5, 12, 2, 5, 15, 3, 8, 6, 12, 11, 14, 1, 14, 2, 8, 1, 3, 13, 
    2, 1, 14, 10, 15, 14, 9, 15, 5, 1, 2, 14, 11, 11, 9, 8, 7, 10, 0, 11, 6, 
    11, 3, 3, 11, 12, 15, 11, 7, 12, 0, 14, 11, 4, 7, 3, 10, 15, 13, 4, 6, 12, 
    14, 11, 14, 13, 8, 8, 5, 9, 2, 15, 4, 1, 11, 7, 6, 11, 8, 6, 2, 1, 12, 10, 
    12, 11, 3, 15, 1, 9, 1, 14, 5, 15, 4, 12, 3, 8, 10, 9, 7, 4, 15, 11, 9, 1, 
    1, 13, 7, 9, 1, 13, 6, 9, 0, 11, 14, 15, 12, 9, 3, 15, 8, 14, 15, 10, 7, 
    11, 15, 11, 15, 15, 14, 5, 15, 0, 1, 10, 2, 13, 15, 5, 3, 10, 14, 13, 11, 
    7, 12, 4, 14, 1, 5, 14, 8, 10, 14, 3, 13, 12, 13, 4, 2, 9, 13, 2, 2, 14, 
    11, 3, 7, 5, 9, 1, 7, 10, 5, 15, 14, 2, 4, 2, 4, 4, 4, 0, 5, 11, 0, 10, 5, 
    1, 4, 13, 0, 13, 10, 5, 9, 6, 2, 7, 0, 10, 10, 9, 8, 14, 12, 8, 6, 0, 8, 5, 
    14, 8, 9, 4, 12, 1, 7, 10, 0, 0 };

static uint64_t upm1_stage1(uint64_t rho, uint64_t n, uint64_t one, uint64_t stg1)
{
    int i;
    uint64_t P = one;
    uint64_t g[16];

    g[0] = one;
    for (i = 1; i < 16; i++)
        g[i] = upm1_addmod(g[i-1], g[i-1], n);

    switch (stg1)
    {
    case 33:
        for (i = 0; i < 12; i++) {
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            if (ewin33[i] > 0) P = upm1_mulredc(P, g[ewin33[i]], n, rho);
        }
        break;
    case 100:
        for (i = 0; i < 34; i++) {
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            if (ewin100[i] > 0) P = upm1_mulredc(P, g[ewin100[i]], n, rho);
        }
        break;
    case 333:
        for (i = 0; i < 119; i++) {
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            if (ewin333[i] > 0) P = upm1_mulredc(P, g[ewin333[i]], n, rho);
        }
        break;
    case 666:
        for (i = 0; i < 243; i++) {
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            if (ewin666[i] > 0) P = upm1_mulredc(P, g[ewin666[i]], n, rho);
        }
        break;
    case 1000:
        for (i = 0; i < 360; i++) {
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            P = upm1_sqrredc(P, n, rho);
            if (ewin1000[i] > 0) P = upm1_mulredc(P, g[ewin1000[i]], n, rho);
        }
        break;
    }
    return P;
}

void upm1_generate_window_plan(uint64_t B1)
{
    int i, j;
    mpz_t e;
    uint64_t q;
    mpz_init(e);

    uint64_t p[168] = { 2, 3, 5, 7,
        11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97,
        101, 103, 107, 109, 113, 127, 131, 137, 139, 149, 151, 157, 163, 167, 173, 179,
        181, 191, 193, 197, 199, 211, 223, 227, 229, 233, 239, 241, 251, 257, 263, 269,
        271, 277, 281, 283, 293, 307, 311, 313, 317, 331, 337, 347, 349, 353, 359, 367,
        373, 379, 383, 389, 397, 401, 409, 419, 421, 431, 433, 439, 443, 449, 457, 461,
        463, 467, 479, 487, 491, 499, 503, 509, 521, 523, 541, 547, 557, 563, 569, 571,
        577, 587, 593, 599, 601, 607, 613, 617, 619, 631, 641, 643, 647, 653, 659, 661,
        673, 677, 683, 691, 701, 709, 719, 727, 733, 739, 743, 751, 757, 761, 769, 773,
        787, 797, 809, 811, 821, 823, 827, 829, 839, 853, 857, 859, 863, 877, 881, 883,
        887, 907, 911, 919, 929, 937, 941, 947, 953, 967, 971, 977, 983, 991, 997 };

    int g[1024];

    mpz_set_ui(e, 1);
    for (i = 0; i < 168; i++)
    {
        if (p[i] > B1)
            break;

        q = p[i];
        while ((q * p[i]) < B1)
        {
            q *= p[i];
        }
        mpz_mul_ui(e, e, q);
        gmp_printf("e*=%lu=%Zx\n", q, e);
    }

    // now we have the exponent, generate a LR-kary windowing plan.
    // assume window size 4.
    j = 0;
    while (mpz_cmp_ui(e, 0) > 0)
    {
        g[j++] =  mpz_get_ui(e) & 0xf;
        mpz_tdiv_q_2exp(e, e, 4);
    }
    printf("%d: \n", j);

    while (j > 0)
        printf("%d,", g[--j]);
    printf("\n");

    mpz_clear(e);
    return;
}

#ifdef MICRO_PM1_VERBOSE_PRINTF
static void upm1_stage2_pair(int b1, int b2, 
    int Astart, int D, int AD, int *p)
{
    // a very simple pairing procedure.  
    int pid = 0;
    int A;
    int i;
    int* pairs;
    int steps[1000];
    int s = 0;

    pairs = (int*)malloc(D * sizeof(int));

    printf("commencing pair for A0=%d, D=%d, b1=%d, b2=%d\n",
        Astart, D, b1, b2);

    while (p[pid] < b1) {
        pid++;
    }

    printf("now at p=%d\n", p[pid]);

    for (i = 0; i < D; i++)
    {
        pairs[i] = 0;
    }

    A = Astart;

    while (p[pid] < b2)
    {
        int b = A - p[pid];

        if ((p[pid] - A) > (D / 2))
        {
            A += D;
            printf("new A = %d\n", A);
            for (i = 0; i < D / 2; i++)
            {
                pairs[i] = 0;
            }
            steps[s++] = 0;
            continue;
        }

        if (b > 0)
        {
            if (b > D / 2)
            {
                printf("unable to pair %d\n", primes[pid]);
                pid++;
                continue;
            }

            printf("new pair %d +/- %d (%d:%d)\n", A, b, A - b, A + b);
            pairs[b] = 1;
            steps[s++] = b;
        }
        else
        {
            if (pairs[abs(b)] == 0)
            {
                printf("leftover pair %d +/- %d (%d:%d)\n", A, b, A - b, A + b);
                steps[s++] = abs(b);
            }
            
        }

        pid++;
    }

    free(pairs);

    printf("steps[%d] = {", s);
    for (i = 0; i < s; i++)
    {
        if (i % 16 == 0) printf("\n");
        printf("%d,", steps[i]);
    }
    printf("\b};\n");
    return;
}
#endif

static uint64_t upm1_expRL(uint64_t P, uint64_t n, uint64_t rho, uint64_t one, uint32_t m)
{
    uint64_t s = P;
    P = one;

    while (m > 0)
    {
        if (m & 1)
            P = upm1_mulredc(P, s, n, rho);
        s = upm1_sqrredc(s, n, rho);
        m >>= 1;
    }
    return P;
}

static const uint32_t upm1_map[60] = {
    0, 1, 2, 0, 0, 0, 0, 3, 0, 0,
    0, 4, 0, 5, 0, 0, 0, 6, 0, 7,
    0, 0, 0, 8, 0, 0, 0, 0, 0, 9,
    0, 10, 0, 0, 0, 0, 0, 11, 0, 0,
    0, 12, 0, 13, 0, 0, 0, 14, 0, 15,
    0, 0, 0, 16, 0, 0, 0, 0, 0, 17 };

/* baby-steps, giant-steps for b1 = 33, b2 = 825, w = 60
q0 = 60 */
static int num_b1_33_steps = 145;
static uint8_t b1_33_steps[145] = {
23, 19, 17, 13, 7, 1, 0,
59, 53, 49, 47, 41, 37, 31, 23, 19, 17, 13, 11, 7, 0,
53, 49, 43, 41, 31, 29, 23, 17, 13, 7, 1, 0,
59, 49, 47, 43, 41, 29, 17, 13, 11, 7, 1, 0,
59, 49, 43, 37, 31, 29, 23, 19, 17, 7, 0,
53, 49, 47, 43, 29, 23, 13, 11, 7, 1, 0,
53, 47, 41, 37, 31, 23, 19, 11, 1, 0,
59, 49, 47, 41, 37, 31, 23, 19, 17, 13, 1, 0,
53, 49, 41, 37, 31, 19, 17, 0,
59, 53, 43, 37, 31, 29, 23, 13, 7, 1, 0,
59, 53, 47, 43, 41, 29, 19, 17, 13, 7, 1, 0,
59, 47, 43, 37, 29, 19, 11, 1, 0,
53, 47, 41, 37, 29, 23, 19, 11, 7, 0,
53, 43, 31, 29, 19, 17};

/* baby-steps, giant-steps for b1 = 100, w = 60
q0 = 120 */
static int num_b1_100_steps = 382;
static uint8_t b1_100_steps[382] = {
19, 17, 13, 11, 7, 0,
53, 49, 43, 41, 31, 29, 23, 17, 13, 7, 1, 0,
59, 49, 47, 43, 41, 29, 17, 13, 11, 7, 1, 0,
59, 49, 43, 37, 31, 29, 23, 19, 17, 7, 0,
53, 49, 47, 43, 29, 23, 13, 11, 7, 1, 0,
53, 47, 41, 37, 31, 23, 19, 11, 1, 0,
59, 49, 47, 41, 37, 31, 23, 19, 17, 13, 1, 0,
53, 49, 41, 37, 31, 19, 17, 0,
59, 53, 43, 37, 31, 29, 23, 13, 7, 1, 0,
59, 53, 47, 43, 41, 29, 19, 17, 13, 7, 1, 0,
59, 47, 43, 37, 29, 19, 11, 1, 0,
53, 47, 41, 37, 29, 23, 19, 11, 7, 0,
53, 43, 31, 29, 19, 17, 13, 11, 1, 0,
47, 43, 41, 37, 23, 19, 17, 13, 0,
53, 49, 41, 31, 23, 19, 13, 7, 0,
53, 49, 43, 37, 29, 23, 11, 7, 1, 0,
59, 49, 47, 41, 31, 29, 19, 17, 11, 0,
53, 49, 47, 43, 37, 31, 23, 17, 11, 0,
49, 47, 37, 29, 19, 13, 7, 0,
59, 47, 43, 37, 31, 29, 23, 11, 1, 0,
43, 41, 37, 31, 29, 23, 19, 17, 13, 1, 0,
59, 53, 19, 13, 7, 0,
59, 41, 31, 17, 13, 11, 7, 1, 0,
53, 49, 47, 41, 29, 19, 17, 13, 11, 7, 1, 0,
49, 37, 29, 17, 11, 7, 1, 0,
53, 49, 41, 37, 23, 19, 13, 11, 7, 1, 0,
59, 53, 43, 23, 17, 13, 11, 0,
47, 43, 41, 31, 19, 17, 7, 0,
59, 53, 47, 41, 23, 17, 13, 11, 0,
59, 49, 37, 29, 13, 0,
59, 53, 49, 47, 43, 41, 31, 19, 13, 7, 0,
49, 47, 31, 29, 7, 1, 0,
53, 47, 43, 41, 37, 29, 23, 13, 11, 1, 0,
47, 37, 31, 19, 17, 13, 11, 1, 0,
49, 47, 31, 29, 23, 19, 17, 7, 0,
59, 41, 17, 13, 7, 0,
59, 43, 41, 37, 29, 13, 11, 7, 0,
59, 53, 47, 43, 31, 29, 7, 1, 0,
59, 53, 49, 43, 29, 23, 19, 17, 11, 7, 1, 0,
49, 43, 37, 23, 19, 13, 1, 0,
53, 47, 43};

/* baby-steps, giant-steps for b1 = 333, w = 60
q0 = 360
*/
static int num_b1_333_steps = 1110;
static uint8_t b1_333_steps[1110] = {
23, 13, 11, 7, 1, 0,
53, 47, 41, 37, 31, 23, 19, 11, 1, 0,
59, 49, 47, 41, 37, 31, 23, 19, 17, 13, 1, 0,
53, 49, 41, 37, 31, 19, 17, 0,
59, 53, 43, 37, 31, 29, 23, 13, 7, 1, 0,
59, 53, 47, 43, 41, 29, 19, 17, 13, 7, 1, 0,
59, 47, 43, 37, 29, 19, 11, 1, 0,
53, 47, 41, 37, 29, 23, 19, 11, 7, 0,
53, 43, 31, 29, 19, 17, 13, 11, 1, 0,
47, 43, 41, 37, 23, 19, 17, 13, 0,
53, 49, 41, 31, 23, 19, 13, 7, 0,
53, 49, 43, 37, 29, 23, 11, 7, 1, 0,
59, 49, 47, 41, 31, 29, 19, 17, 11, 0,
53, 49, 47, 43, 37, 31, 23, 17, 11, 0,
49, 47, 37, 29, 19, 13, 7, 0,
59, 47, 43, 37, 31, 29, 23, 11, 1, 0,
43, 41, 37, 31, 29, 23, 19, 17, 13, 1, 0,
59, 53, 19, 13, 7, 0,
59, 41, 31, 17, 13, 11, 7, 1, 0,
53, 49, 47, 41, 29, 19, 17, 13, 11, 7, 1, 0,
49, 37, 29, 17, 11, 7, 1, 0,
53, 49, 41, 37, 23, 19, 13, 11, 7, 1, 0,
59, 53, 43, 23, 17, 13, 11, 0,
47, 43, 41, 31, 19, 17, 7, 0,
59, 53, 47, 41, 23, 17, 13, 11, 0,
59, 49, 37, 29, 13, 0,
59, 53, 49, 47, 43, 41, 31, 19, 13, 7, 0,
49, 47, 31, 29, 7, 1, 0,
53, 47, 43, 41, 37, 29, 23, 13, 11, 1, 0,
47, 37, 31, 19, 17, 13, 11, 1, 0,
49, 47, 31, 29, 23, 19, 17, 7, 0,
59, 41, 17, 13, 7, 0,
59, 43, 41, 37, 29, 13, 11, 7, 0,
59, 53, 47, 43, 31, 29, 7, 1, 0,
59, 53, 49, 43, 29, 23, 19, 17, 11, 7, 1, 0,
49, 43, 37, 23, 19, 13, 1, 0,
53, 47, 43, 17, 0,
59, 49, 41, 37, 31, 29, 23, 1, 0,
49, 47, 31, 23, 19, 7, 0,
53, 43, 41, 37, 29, 23, 17, 13, 11, 7, 1, 0,
53, 49, 47, 41, 31, 29, 19, 11, 7, 0,
53, 43, 31, 29, 23, 19, 17, 1, 0,
47, 43, 37, 29, 23, 19, 1, 0,
53, 43, 37, 31, 23, 13, 1, 0,
47, 43, 37, 31, 29, 1, 0,
59, 49, 41, 37, 23, 19, 11, 0,
59, 53, 41, 37, 31, 11, 1, 0,
59, 43, 17, 13, 11, 0,
59, 53, 49, 37, 31, 23, 19, 11, 0,
49, 47, 43, 41, 29, 1, 0,
59, 53, 47, 41, 37, 31, 29, 17, 13, 1, 0,
59, 49, 47, 31, 29, 13, 7, 0,
47, 31, 23, 19, 17, 13, 11, 0,
49, 41, 29, 23, 13, 11, 7, 1, 0,
59, 53, 43, 41, 29, 19, 17, 7, 0,
53, 47, 43, 37, 29, 23, 17, 1, 0,
49, 47, 43, 29, 23, 19, 11, 1, 0,
53, 47, 41, 19, 13, 11, 1, 0,
47, 43, 37, 19, 17, 7, 0,
53, 49, 47, 37, 23, 19, 11, 0,
53, 49, 43, 41, 37, 31, 29, 17, 13, 0,
53, 31, 19, 17, 13, 7, 1, 0,
59, 53, 31, 29, 23, 7, 1, 0,
49, 47, 41, 29, 13, 11, 7, 1, 0,
47, 43, 41, 23, 0,
59, 49, 43, 41, 31, 29, 19, 17, 7, 1, 0,
59, 49, 47, 37, 31, 23, 0,
53, 43, 41, 31, 23, 17, 7, 0,
49, 43, 31, 19, 17, 0,
59, 53, 49, 43, 37, 19, 17, 7, 0,
53, 47, 43, 41, 37, 13, 11, 0,
59, 53, 37, 29, 23, 17, 0,
59, 43, 41, 37, 31, 29, 23, 17, 7, 1, 0,
49, 37, 19, 17, 11, 7, 0,
49, 41, 17, 13, 11, 7, 1, 0,
59, 47, 43, 29, 0,
59, 49, 43, 31, 17, 11, 1, 0,
49, 47, 43, 37, 29, 23, 13, 11, 7, 0,
53, 47, 41, 37, 31, 29, 19, 17, 1, 0,
49, 41, 23, 19, 13, 1, 0,
59, 53, 47, 41, 13, 7, 0,
53, 49, 41, 31, 23, 11, 0,
53, 49, 47, 43, 19, 7, 1, 0,
59, 43, 37, 31, 17, 7, 0,
53, 49, 19, 13, 7, 1, 0,
53, 47, 43, 41, 29, 23, 19, 17, 11, 0,
49, 43, 41, 37, 19, 17, 13, 1, 0,
59, 53, 49, 23, 17, 11, 7, 0,
59, 49, 17, 1, 0,
59, 53, 49, 47, 43, 41, 31, 17, 11, 7, 0,
59, 49, 43, 23, 19, 17, 11, 0,
41, 37, 29, 19, 13, 7, 0,
59, 53, 41, 37, 31, 29, 23, 19, 13, 11, 1, 0,
59, 43, 37, 17, 13, 1, 0,
47, 19, 13, 0,
53, 49, 31, 23, 17, 13, 7, 0,
53, 47, 41, 31, 29, 19, 7, 0,
59, 49, 47, 37, 29, 17, 7, 0,
43, 41, 37, 29, 23, 19, 11, 0,
53, 43, 37, 31, 29, 23, 13, 1, 0,
59, 49, 43, 37, 31, 23, 17, 7, 1, 0,
59, 53, 47, 41, 31, 23, 0,
59, 53, 31, 29, 11, 7, 0,
59, 49, 19, 11, 0,
53, 49, 47, 37, 31, 29, 23, 19, 1, 0,
53, 41, 23, 7, 1, 0,
59, 47, 41, 31, 29, 19, 17, 11, 1, 0,
47, 43, 19, 17, 1, 0,
59, 49, 47, 37, 17, 13, 11, 7, 0,
59, 43, 37, 31, 29, 17, 1, 0,
53, 49, 43, 13, 11, 1, 0,
59, 53, 49, 43, 37, 29, 23, 19, 7, 1, 0,
53, 41, 37, 23, 11, 1, 0,
37, 31, 19, 13, 11, 0,
49, 41, 23, 13, 7, 0,
53, 49, 47, 41, 31, 23, 17, 13, 7, 0,
37, 23, 13, 11, 0,
59, 49, 47, 31, 29, 11, 0,
47, 29, 23, 7, 0,
49, 43, 41, 23, 19, 13, 11, 1, 0,
53, 43, 37, 31, 23, 19, 13, 11, 1, 0,
59, 47, 43, 37, 31, 29, 17, 13, 0,
59, 41, 37, 31, 11, 7, 0,
59, 53, 49, 41, 37, 23, 17, 13, 0,
59, 47, 43, 41, 11, 7, 0,
43, 37, 31, 19, 7, 0,
53, 47, 43, 41, 37, 19, 13, 1, 0,
53, 47, 43, 31, 29, 17, 0,
47, 31, 29, 23, 1, 0,
47, 41, 31, 19, 13, 11, 7, 0,
59, 49, 43, 37, 13, 0,
59, 53, 49, 41, 29, 11, 1, 0,
59, 49, 47, 43, 37, 17, 11, 7, 0,
53, 49, 47, 43, 29, 23};

/* baby-steps, giant-steps pairing for b1 = 100, w = 60
q0 = 120 */
static int num_b1_100_pairs = 279;
static uint8_t b1_100_pairs[279] = {
19, 17, 13, 11, 7, 29, 31, 37, 43, 47, 53, 59, 0,
59, 49, 47, 43, 41, 29, 17, 13, 11, 7, 1, 23, 31, 37, 53, 0,
53, 49, 47, 43, 29, 23, 13, 11, 7, 1, 19, 37, 41, 59, 0,
59, 49, 47, 41, 37, 31, 23, 19, 17, 13, 1, 7, 11, 29, 43, 0,
59, 53, 43, 37, 31, 29, 23, 13, 7, 1, 17, 19, 41, 47, 0,
59, 47, 43, 37, 29, 19, 11, 1, 7, 13, 23, 31, 41, 49, 53, 0,
53, 43, 31, 29, 19, 17, 13, 11, 1, 23, 37, 41, 47, 0,
53, 49, 41, 31, 23, 19, 13, 7, 11, 17, 37, 59, 0,
59, 49, 47, 41, 31, 29, 19, 17, 11, 7, 13, 23, 37, 43, 0,
49, 47, 37, 29, 19, 13, 7, 1, 17, 23, 31, 59, 0,
43, 41, 37, 31, 29, 23, 19, 17, 13, 1, 7, 47, 53, 0,
59, 41, 31, 17, 13, 11, 7, 1, 19, 43, 47, 49, 53, 0,
49, 37, 29, 17, 11, 7, 1, 19, 23, 41, 47, 53, 59, 0,
59, 53, 43, 23, 17, 13, 11, 19, 29, 41, 0,
59, 53, 47, 41, 23, 17, 13, 11, 1, 31, 0,
59, 53, 49, 47, 43, 41, 31, 19, 13, 7, 11, 29, 0,
53, 47, 43, 41, 37, 29, 23, 13, 11, 1, 49, 59, 0,
49, 47, 31, 29, 23, 19, 17, 7, 1, 43, 53, 0,
59, 43, 41, 37, 29, 13, 11, 7, 1, 17, 31, 53, 0,
59, 53, 49, 43, 29, 23, 19, 17, 11, 7, 1, 37, 41, 47, 0,
53, 47, 43 };

/* baby-steps, giant-steps pairing for b1 = 333, w = 60
q0 = 360
*/
static int num_b1_333_pairs = 837;
static uint8_t b1_333_pairs[837] = {
23, 13, 11, 7, 1, 19, 29, 37, 41, 49, 59, 0,
59, 49, 47, 41, 37, 31, 23, 19, 17, 13, 1, 7, 11, 29, 43, 0,
59, 53, 43, 37, 31, 29, 23, 13, 7, 1, 17, 19, 41, 47, 0,
59, 47, 43, 37, 29, 19, 11, 1, 7, 13, 23, 31, 41, 49, 53, 0,
53, 43, 31, 29, 19, 17, 13, 11, 1, 23, 37, 41, 47, 0,
53, 49, 41, 31, 23, 19, 13, 7, 11, 17, 37, 59, 0,
59, 49, 47, 41, 31, 29, 19, 17, 11, 7, 13, 23, 37, 43, 0,
49, 47, 37, 29, 19, 13, 7, 1, 17, 23, 31, 59, 0,
43, 41, 37, 31, 29, 23, 19, 17, 13, 1, 7, 47, 53, 0,
59, 41, 31, 17, 13, 11, 7, 1, 19, 43, 47, 49, 53, 0,
49, 37, 29, 17, 11, 7, 1, 19, 23, 41, 47, 53, 59, 0,
59, 53, 43, 23, 17, 13, 11, 19, 29, 41, 0,
59, 53, 47, 41, 23, 17, 13, 11, 1, 31, 0,
59, 53, 49, 47, 43, 41, 31, 19, 13, 7, 11, 29, 0,
53, 47, 43, 41, 37, 29, 23, 13, 11, 1, 49, 59, 0,
49, 47, 31, 29, 23, 19, 17, 7, 1, 43, 53, 0,
59, 43, 41, 37, 29, 13, 11, 7, 1, 17, 31, 53, 0,
59, 53, 49, 43, 29, 23, 19, 17, 11, 7, 1, 37, 41, 47, 0,
53, 47, 43, 17, 1, 11, 19, 23, 29, 31, 37, 59, 0,
49, 47, 31, 23, 19, 7, 17, 37, 43, 53, 59, 0,
53, 49, 47, 41, 31, 29, 19, 11, 7, 17, 37, 43, 59, 0,
47, 43, 37, 29, 23, 19, 1, 7, 17, 59, 0,
47, 43, 37, 31, 29, 1, 11, 19, 23, 41, 49, 0,
59, 53, 41, 37, 31, 11, 1, 17, 43, 47, 49, 0,
59, 53, 49, 37, 31, 23, 19, 11, 13, 17, 0,
59, 53, 47, 41, 37, 31, 29, 17, 13, 1, 11, 0,
47, 31, 23, 19, 17, 13, 11, 37, 49, 53, 59, 0,
59, 53, 43, 41, 29, 19, 17, 7, 13, 23, 31, 37, 0,
49, 47, 43, 29, 23, 19, 11, 1, 7, 13, 41, 59, 0,
47, 43, 37, 19, 17, 7, 11, 13, 23, 41, 49, 0,
53, 49, 43, 41, 37, 31, 29, 17, 13, 7, 47, 59, 0,
59, 53, 31, 29, 23, 7, 1, 11, 13, 19, 47, 49, 0,
47, 43, 41, 23, 1, 11, 17, 19, 29, 31, 53, 59, 0,
59, 49, 47, 37, 31, 23, 7, 17, 19, 29, 43, 53, 0,
49, 43, 31, 19, 17, 1, 7, 11, 23, 41, 53, 0,
53, 47, 43, 41, 37, 13, 11, 1, 7, 23, 31, 0,
59, 43, 41, 37, 31, 29, 23, 17, 7, 1, 11, 49, 53, 0,
49, 41, 17, 13, 11, 7, 1, 31, 0,
59, 49, 43, 31, 17, 11, 1, 13, 23, 37, 47, 53, 0,
53, 47, 41, 37, 31, 29, 19, 17, 1, 11, 59, 0,
59, 53, 47, 41, 13, 7, 11, 19, 29, 37, 49, 0,
53, 49, 47, 43, 19, 7, 1, 17, 23, 29, 0,
53, 49, 19, 13, 7, 1, 17, 31, 37, 41, 43, 0,
49, 43, 41, 37, 19, 17, 13, 1, 7, 11, 53, 0,
59, 49, 17, 1, 7, 11, 13, 19, 29, 43, 53, 0,
59, 49, 43, 23, 19, 17, 11, 31, 41, 47, 53, 0,
59, 53, 41, 37, 31, 29, 23, 19, 13, 11, 1, 17, 43, 47, 0,
47, 19, 13, 7, 11, 29, 37, 43, 53, 0,
53, 47, 41, 31, 29, 19, 7, 1, 11, 13, 23, 43, 0,
43, 41, 37, 29, 23, 19, 11, 7, 17, 31, 47, 59, 0,
59, 49, 43, 37, 31, 23, 17, 7, 1, 13, 19, 29, 0,
59, 53, 31, 29, 11, 7, 1, 41, 49, 0,
53, 49, 47, 37, 31, 29, 23, 19, 1, 7, 59, 0,
59, 47, 41, 31, 29, 19, 17, 11, 1, 13, 43, 0,
59, 49, 47, 37, 17, 13, 11, 7, 1, 23, 29, 31, 43, 0,
53, 49, 43, 13, 11, 1, 7, 17, 23, 31, 37, 41, 59, 0,
53, 41, 37, 23, 11, 1, 29, 47, 49, 0,
49, 41, 23, 13, 7, 11, 19, 29, 37, 43, 47, 53, 0,
37, 23, 13, 11, 1, 29, 31, 49, 0,
47, 29, 23, 7, 11, 17, 19, 37, 41, 49, 59, 0,
53, 43, 37, 31, 23, 19, 13, 11, 1, 17, 29, 47, 0,
59, 41, 37, 31, 11, 7, 1, 19, 23, 43, 47, 0,
59, 47, 43, 41, 11, 7, 17, 23, 29, 53, 0,
53, 47, 43, 41, 37, 19, 13, 1, 7, 17, 29, 31, 0,
47, 31, 29, 23, 1, 13, 19, 41, 49, 53, 0,
59, 49, 43, 37, 13, 1, 7, 11, 19, 31, 0,
59, 49, 47, 43, 37, 17, 11, 7, 13, 31 };

/* baby-steps, giant-steps pairing for b1 = 666, b2 = 16650, w = 60
q0 = 720*/
static int num_b1_666_pairs = 1577;
static uint8_t b1_666_pairs[1577] = {
47, 43, 37, 29, 19, 11, 1, 7, 13, 23, 31, 41, 49, 53, 0,
53, 43, 31, 29, 19, 17, 13, 11, 1, 23, 37, 41, 47, 0,
53, 49, 41, 31, 23, 19, 13, 7, 11, 17, 37, 59, 0,
59, 49, 47, 41, 31, 29, 19, 17, 11, 7, 13, 23, 37, 43, 0,
49, 47, 37, 29, 19, 13, 7, 1, 17, 23, 31, 59, 0,
43, 41, 37, 31, 29, 23, 19, 17, 13, 1, 7, 47, 53, 0,
59, 41, 31, 17, 13, 11, 7, 1, 19, 43, 47, 49, 53, 0,
49, 37, 29, 17, 11, 7, 1, 19, 23, 41, 47, 53, 59, 0,
59, 53, 43, 23, 17, 13, 11, 19, 29, 41, 0,
59, 53, 47, 41, 23, 17, 13, 11, 1, 31, 0,
59, 53, 49, 47, 43, 41, 31, 19, 13, 7, 11, 29, 0,
53, 47, 43, 41, 37, 29, 23, 13, 11, 1, 49, 59, 0,
49, 47, 31, 29, 23, 19, 17, 7, 1, 43, 53, 0,
59, 43, 41, 37, 29, 13, 11, 7, 1, 17, 31, 53, 0,
59, 53, 49, 43, 29, 23, 19, 17, 11, 7, 1, 37, 41, 47, 0,
53, 47, 43, 17, 1, 11, 19, 23, 29, 31, 37, 59, 0,
49, 47, 31, 23, 19, 7, 17, 37, 43, 53, 59, 0,
53, 49, 47, 41, 31, 29, 19, 11, 7, 17, 37, 43, 59, 0,
47, 43, 37, 29, 23, 19, 1, 7, 17, 59, 0,
47, 43, 37, 31, 29, 1, 11, 19, 23, 41, 49, 0,
59, 53, 41, 37, 31, 11, 1, 17, 43, 47, 49, 0,
59, 53, 49, 37, 31, 23, 19, 11, 13, 17, 0,
59, 53, 47, 41, 37, 31, 29, 17, 13, 1, 11, 0,
47, 31, 23, 19, 17, 13, 11, 37, 49, 53, 59, 0,
59, 53, 43, 41, 29, 19, 17, 7, 13, 23, 31, 37, 0,
49, 47, 43, 29, 23, 19, 11, 1, 7, 13, 41, 59, 0,
47, 43, 37, 19, 17, 7, 11, 13, 23, 41, 49, 0,
53, 49, 43, 41, 37, 31, 29, 17, 13, 7, 47, 59, 0,
59, 53, 31, 29, 23, 7, 1, 11, 13, 19, 47, 49, 0,
47, 43, 41, 23, 1, 11, 17, 19, 29, 31, 53, 59, 0,
59, 49, 47, 37, 31, 23, 7, 17, 19, 29, 43, 53, 0,
49, 43, 31, 19, 17, 1, 7, 11, 23, 41, 53, 0,
53, 47, 43, 41, 37, 13, 11, 1, 7, 23, 31, 0,
59, 43, 41, 37, 31, 29, 23, 17, 7, 1, 11, 49, 53, 0,
49, 41, 17, 13, 11, 7, 1, 31, 0,
59, 49, 43, 31, 17, 11, 1, 13, 23, 37, 47, 53, 0,
53, 47, 41, 37, 31, 29, 19, 17, 1, 11, 59, 0,
59, 53, 47, 41, 13, 7, 11, 19, 29, 37, 49, 0,
53, 49, 47, 43, 19, 7, 1, 17, 23, 29, 0,
53, 49, 19, 13, 7, 1, 17, 31, 37, 41, 43, 0,
49, 43, 41, 37, 19, 17, 13, 1, 7, 11, 53, 0,
59, 49, 17, 1, 7, 11, 13, 19, 29, 43, 53, 0,
59, 49, 43, 23, 19, 17, 11, 31, 41, 47, 53, 0,
59, 53, 41, 37, 31, 29, 23, 19, 13, 11, 1, 17, 43, 47, 0,
47, 19, 13, 7, 11, 29, 37, 43, 53, 0,
53, 47, 41, 31, 29, 19, 7, 1, 11, 13, 23, 43, 0,
43, 41, 37, 29, 23, 19, 11, 7, 17, 31, 47, 59, 0,
59, 49, 43, 37, 31, 23, 17, 7, 1, 13, 19, 29, 0,
59, 53, 31, 29, 11, 7, 1, 41, 49, 0,
53, 49, 47, 37, 31, 29, 23, 19, 1, 7, 59, 0,
59, 47, 41, 31, 29, 19, 17, 11, 1, 13, 43, 0,
59, 49, 47, 37, 17, 13, 11, 7, 1, 23, 29, 31, 43, 0,
53, 49, 43, 13, 11, 1, 7, 17, 23, 31, 37, 41, 59, 0,
53, 41, 37, 23, 11, 1, 29, 47, 49, 0,
49, 41, 23, 13, 7, 11, 19, 29, 37, 43, 47, 53, 0,
37, 23, 13, 11, 1, 29, 31, 49, 0,
47, 29, 23, 7, 11, 17, 19, 37, 41, 49, 59, 0,
53, 43, 37, 31, 23, 19, 13, 11, 1, 17, 29, 47, 0,
59, 41, 37, 31, 11, 7, 1, 19, 23, 43, 47, 0,
59, 47, 43, 41, 11, 7, 17, 23, 29, 53, 0,
53, 47, 43, 41, 37, 19, 13, 1, 7, 17, 29, 31, 0,
47, 31, 29, 23, 1, 13, 19, 41, 49, 53, 0,
59, 49, 43, 37, 13, 1, 7, 11, 19, 31, 0,
59, 49, 47, 43, 37, 17, 11, 7, 13, 31, 0,
47, 37, 31, 23, 13, 11, 19, 29, 43, 0,
59, 53, 19, 7, 1, 17, 23, 43, 0,
59, 43, 41, 31, 17, 13, 11, 1, 7, 23, 29, 37, 49, 53, 0,
53, 47, 41, 29, 23, 19, 13, 7, 1, 43, 59, 0,
59, 49, 43, 41, 31, 19, 17, 13, 7, 53, 0,
59, 49, 37, 31, 29, 1, 7, 11, 13, 41, 43, 0,
53, 29, 17, 11, 7, 13, 31, 37, 41, 0,
59, 53, 41, 37, 31, 19, 13, 1, 17, 43, 0,
49, 41, 37, 23, 19, 17, 11, 31, 43, 53, 59, 0,
59, 49, 47, 43, 41, 19, 17, 13, 7, 1, 11, 31, 53, 0,
53, 49, 13, 1, 19, 23, 29, 31, 43, 0,
59, 43, 41, 31, 23, 1, 13, 19, 29, 47, 49, 0,
59, 53, 49, 37, 29, 23, 11, 7, 1, 17, 19, 31, 43, 47, 0,
59, 53, 37, 31, 29, 19, 11, 7, 13, 47, 49, 0,
43, 41, 19, 13, 11, 1, 23, 31, 53, 59, 0,
59, 49, 41, 37, 31, 23, 19, 7, 11, 43, 47, 53, 0,
53, 49, 47, 31, 19, 17, 7, 1, 11, 13, 23, 37, 0,
49, 41, 13, 11, 7, 17, 19, 23, 37, 47, 59, 0,
59, 47, 31, 29, 1, 7, 37, 41, 53, 0,
53, 49, 41, 29, 23, 17, 13, 7, 11, 31, 43, 59, 0,
47, 29, 19, 11, 1, 31, 37, 53, 59, 0,
59, 53, 37, 31, 29, 17, 11, 19, 0,
53, 47, 37, 13, 7, 17, 19, 29, 31, 43, 0,
47, 43, 41, 29, 11, 1, 13, 17, 37, 53, 0,
41, 37, 29, 23, 19, 7, 1, 31, 49, 0,
49, 47, 31, 17, 7, 1, 11, 23, 37, 43, 0,
53, 49, 37, 31, 29, 23, 17, 1, 7, 59, 0,
53, 47, 43, 23, 19, 7, 17, 37, 41, 49, 59, 0,
59, 43, 41, 29, 17, 19, 23, 47, 53, 0,
59, 53, 49, 47, 41, 17, 13, 7, 23, 29, 43, 0,
59, 47, 41, 31, 29, 19, 13, 7, 11, 37, 43, 49, 0,
49, 47, 23, 19, 13, 11, 7, 1, 29, 37, 41, 43, 0,
43, 37, 29, 13, 1, 11, 23, 41, 49, 0,
59, 37, 31, 17, 13, 19, 41, 49, 53, 0,
59, 47, 43, 29, 23, 7, 1, 11, 17, 31, 37, 0,
59, 53, 47, 31, 23, 17, 11, 1, 13, 19, 37, 41, 0,
49, 31, 23, 17, 7, 1, 19, 37, 43, 0,
59, 49, 41, 31, 19, 17, 11, 1, 13, 53, 0,
53, 49, 43, 41, 37, 19, 7, 1, 13, 23, 47, 0,
47, 43, 37, 31, 17, 13, 19, 23, 29, 41, 0,
53, 49, 41, 37, 29, 23, 17, 13, 19, 59, 0,
53, 29, 23, 11, 7, 17, 19, 47, 0,
59, 43, 41, 29, 23, 19, 1, 11, 17, 37, 47, 0,
47, 37, 23, 7, 17, 31, 53, 59, 0,
53, 47, 31, 11, 1, 7, 13, 17, 29, 41, 43, 49, 0,
49, 43, 41, 37, 19, 11, 1, 7, 29, 31, 59, 0,
47, 43, 41, 37, 19, 17, 13, 7, 1, 11, 0,
43, 41, 31, 29, 11, 7, 17, 47, 0,
53, 17, 11, 7, 1, 13, 37, 47, 0,
59, 37, 31, 29, 1, 13, 23, 41, 43, 47, 0,
59, 53, 31, 13, 11, 1, 7, 19, 23, 37, 47, 49, 0,
59, 41, 31, 17, 1, 13, 23, 29, 37, 43, 0,
49, 47, 19, 13, 11, 7, 1, 17, 29, 43, 59, 0,
47, 43, 37, 29, 23, 19, 13, 7, 1, 11, 53, 0,
59, 53, 49, 37, 29, 13, 11, 1, 7, 17, 43, 0,
53, 49, 43, 31, 17, 13, 0,
59, 47, 43, 37, 29, 19, 13, 1, 11, 17, 41, 53, 0,
53, 47, 41, 23, 13, 7, 1, 19, 29, 31, 37, 49, 59, 0,
53, 47, 41, 31, 29, 11, 1, 13, 17, 23, 0,
53, 41, 37, 29, 19, 13, 7, 17, 31, 47, 0,
59, 49, 41, 31, 19, 17, 1, 7, 29, 43, 47, 0,
59, 53, 49, 41, 37, 7, 11, 13, 17, 19, 29, 47, 0,
53, 49, 43, 37, 31, 23, 17, 19, 41, 47, 0,
59, 53, 47, 41, 37, 23, 1, 11, 13, 31, 0,
47, 23, 19, 17, 13, 11, 7, 31, 59, 0,
59, 17, 13, 11, 7, 23, 29, 31, 49, 53, 0,
53, 47, 19, 1, 13, 29, 41, 43, 49, 0,
59, 29, 23, 19, 13, 7, 11, 37, 41, 47, 53, 0,
41, 31, 13, 7, 1, 43, 47, 59, 0,
49, 47, 31};


/* baby-steps, giant-steps pairing for b1 = 1000, b2 = 25000, w = 60 */ 
//q0 = 1080 (note this misses the first 3 primes in the range 1000 - 1080)
static int num_b1_1000_pairs = 2275;
static uint8_t b1_1000_pairs[2275] = {
59, 49, 47, 41, 31, 29, 19, 17, 11, 7, 13, 23, 37, 43, 0,
49, 47, 37, 29, 19, 13, 7, 1, 17, 23, 31, 59, 0,
43, 41, 37, 31, 29, 23, 19, 17, 13, 1, 7, 47, 53, 0,
59, 41, 31, 17, 13, 11, 7, 1, 19, 43, 47, 49, 53, 0,
49, 37, 29, 17, 11, 7, 1, 19, 23, 41, 47, 53, 59, 0,
59, 53, 43, 23, 17, 13, 11, 19, 29, 41, 0,
59, 53, 47, 41, 23, 17, 13, 11, 1, 31, 0,
59, 53, 49, 47, 43, 41, 31, 19, 13, 7, 11, 29, 0,
53, 47, 43, 41, 37, 29, 23, 13, 11, 1, 49, 59, 0,
49, 47, 31, 29, 23, 19, 17, 7, 1, 43, 53, 0,
59, 43, 41, 37, 29, 13, 11, 7, 1, 17, 31, 53, 0,
59, 53, 49, 43, 29, 23, 19, 17, 11, 7, 1, 37, 41, 47, 0,
53, 47, 43, 17, 1, 11, 19, 23, 29, 31, 37, 59, 0,
49, 47, 31, 23, 19, 7, 17, 37, 43, 53, 59, 0,
53, 49, 47, 41, 31, 29, 19, 11, 7, 17, 37, 43, 59, 0,
47, 43, 37, 29, 23, 19, 1, 7, 17, 59, 0,
47, 43, 37, 31, 29, 1, 11, 19, 23, 41, 49, 0,
59, 53, 41, 37, 31, 11, 1, 17, 43, 47, 49, 0,
59, 53, 49, 37, 31, 23, 19, 11, 13, 17, 0,
59, 53, 47, 41, 37, 31, 29, 17, 13, 1, 11, 0,
47, 31, 23, 19, 17, 13, 11, 37, 49, 53, 59, 0,
59, 53, 43, 41, 29, 19, 17, 7, 13, 23, 31, 37, 0,
49, 47, 43, 29, 23, 19, 11, 1, 7, 13, 41, 59, 0,
47, 43, 37, 19, 17, 7, 11, 13, 23, 41, 49, 0,
53, 49, 43, 41, 37, 31, 29, 17, 13, 7, 47, 59, 0,
59, 53, 31, 29, 23, 7, 1, 11, 13, 19, 47, 49, 0,
47, 43, 41, 23, 1, 11, 17, 19, 29, 31, 53, 59, 0,
59, 49, 47, 37, 31, 23, 7, 17, 19, 29, 43, 53, 0,
49, 43, 31, 19, 17, 1, 7, 11, 23, 41, 53, 0,
53, 47, 43, 41, 37, 13, 11, 1, 7, 23, 31, 0,
59, 43, 41, 37, 31, 29, 23, 17, 7, 1, 11, 49, 53, 0,
49, 41, 17, 13, 11, 7, 1, 31, 0,
59, 49, 43, 31, 17, 11, 1, 13, 23, 37, 47, 53, 0,
53, 47, 41, 37, 31, 29, 19, 17, 1, 11, 59, 0,
59, 53, 47, 41, 13, 7, 11, 19, 29, 37, 49, 0,
53, 49, 47, 43, 19, 7, 1, 17, 23, 29, 0,
53, 49, 19, 13, 7, 1, 17, 31, 37, 41, 43, 0,
49, 43, 41, 37, 19, 17, 13, 1, 7, 11, 53, 0,
59, 49, 17, 1, 7, 11, 13, 19, 29, 43, 53, 0,
59, 49, 43, 23, 19, 17, 11, 31, 41, 47, 53, 0,
59, 53, 41, 37, 31, 29, 23, 19, 13, 11, 1, 17, 43, 47, 0,
47, 19, 13, 7, 11, 29, 37, 43, 53, 0,
53, 47, 41, 31, 29, 19, 7, 1, 11, 13, 23, 43, 0,
43, 41, 37, 29, 23, 19, 11, 7, 17, 31, 47, 59, 0,
59, 49, 43, 37, 31, 23, 17, 7, 1, 13, 19, 29, 0,
59, 53, 31, 29, 11, 7, 1, 41, 49, 0,
53, 49, 47, 37, 31, 29, 23, 19, 1, 7, 59, 0,
59, 47, 41, 31, 29, 19, 17, 11, 1, 13, 43, 0,
59, 49, 47, 37, 17, 13, 11, 7, 1, 23, 29, 31, 43, 0,
53, 49, 43, 13, 11, 1, 7, 17, 23, 31, 37, 41, 59, 0,
53, 41, 37, 23, 11, 1, 29, 47, 49, 0,
49, 41, 23, 13, 7, 11, 19, 29, 37, 43, 47, 53, 0,
37, 23, 13, 11, 1, 29, 31, 49, 0,
47, 29, 23, 7, 11, 17, 19, 37, 41, 49, 59, 0,
53, 43, 37, 31, 23, 19, 13, 11, 1, 17, 29, 47, 0,
59, 41, 37, 31, 11, 7, 1, 19, 23, 43, 47, 0,
59, 47, 43, 41, 11, 7, 17, 23, 29, 53, 0,
53, 47, 43, 41, 37, 19, 13, 1, 7, 17, 29, 31, 0,
47, 31, 29, 23, 1, 13, 19, 41, 49, 53, 0,
59, 49, 43, 37, 13, 1, 7, 11, 19, 31, 0,
59, 49, 47, 43, 37, 17, 11, 7, 13, 31, 0,
47, 37, 31, 23, 13, 11, 19, 29, 43, 0,
59, 53, 19, 7, 1, 17, 23, 43, 0,
59, 43, 41, 31, 17, 13, 11, 1, 7, 23, 29, 37, 49, 53, 0,
53, 47, 41, 29, 23, 19, 13, 7, 1, 43, 59, 0,
59, 49, 43, 41, 31, 19, 17, 13, 7, 53, 0,
59, 49, 37, 31, 29, 1, 7, 11, 13, 41, 43, 0,
53, 29, 17, 11, 7, 13, 31, 37, 41, 0,
59, 53, 41, 37, 31, 19, 13, 1, 17, 43, 0,
49, 41, 37, 23, 19, 17, 11, 31, 43, 53, 59, 0,
59, 49, 47, 43, 41, 19, 17, 13, 7, 1, 11, 31, 53, 0,
53, 49, 13, 1, 19, 23, 29, 31, 43, 0,
59, 43, 41, 31, 23, 1, 13, 19, 29, 47, 49, 0,
59, 53, 49, 37, 29, 23, 11, 7, 1, 17, 19, 31, 43, 47, 0,
59, 53, 37, 31, 29, 19, 11, 7, 13, 47, 49, 0,
43, 41, 19, 13, 11, 1, 23, 31, 53, 59, 0,
59, 49, 41, 37, 31, 23, 19, 7, 11, 43, 47, 53, 0,
53, 49, 47, 31, 19, 17, 7, 1, 11, 13, 23, 37, 0,
49, 41, 13, 11, 7, 17, 19, 23, 37, 47, 59, 0,
59, 47, 31, 29, 1, 7, 37, 41, 53, 0,
53, 49, 41, 29, 23, 17, 13, 7, 11, 31, 43, 59, 0,
47, 29, 19, 11, 1, 31, 37, 53, 59, 0,
59, 53, 37, 31, 29, 17, 11, 19, 0,
53, 47, 37, 13, 7, 17, 19, 29, 31, 43, 0,
47, 43, 41, 29, 11, 1, 13, 17, 37, 53, 0,
41, 37, 29, 23, 19, 7, 1, 31, 49, 0,
49, 47, 31, 17, 7, 1, 11, 23, 37, 43, 0,
53, 49, 37, 31, 29, 23, 17, 1, 7, 59, 0,
53, 47, 43, 23, 19, 7, 17, 37, 41, 49, 59, 0,
59, 43, 41, 29, 17, 19, 23, 47, 53, 0,
59, 53, 49, 47, 41, 17, 13, 7, 23, 29, 43, 0,
59, 47, 41, 31, 29, 19, 13, 7, 11, 37, 43, 49, 0,
49, 47, 23, 19, 13, 11, 7, 1, 29, 37, 41, 43, 0,
43, 37, 29, 13, 1, 11, 23, 41, 49, 0,
59, 37, 31, 17, 13, 19, 41, 49, 53, 0,
59, 47, 43, 29, 23, 7, 1, 11, 17, 31, 37, 0,
59, 53, 47, 31, 23, 17, 11, 1, 13, 19, 37, 41, 0,
49, 31, 23, 17, 7, 1, 19, 37, 43, 0,
59, 49, 41, 31, 19, 17, 11, 1, 13, 53, 0,
53, 49, 43, 41, 37, 19, 7, 1, 13, 23, 47, 0,
47, 43, 37, 31, 17, 13, 19, 23, 29, 41, 0,
53, 49, 41, 37, 29, 23, 17, 13, 19, 59, 0,
53, 29, 23, 11, 7, 17, 19, 47, 0,
59, 43, 41, 29, 23, 19, 1, 11, 17, 37, 47, 0,
47, 37, 23, 7, 17, 31, 53, 59, 0,
53, 47, 31, 11, 1, 7, 13, 17, 29, 41, 43, 49, 0,
49, 43, 41, 37, 19, 11, 1, 7, 29, 31, 59, 0,
47, 43, 41, 37, 19, 17, 13, 7, 1, 11, 0,
43, 41, 31, 29, 11, 7, 17, 47, 0,
53, 17, 11, 7, 1, 13, 37, 47, 0,
59, 37, 31, 29, 1, 13, 23, 41, 43, 47, 0,
59, 53, 31, 13, 11, 1, 7, 19, 23, 37, 47, 49, 0,
59, 41, 31, 17, 1, 13, 23, 29, 37, 43, 0,
49, 47, 19, 13, 11, 7, 1, 17, 29, 43, 59, 0,
47, 43, 37, 29, 23, 19, 13, 7, 1, 11, 53, 0,
59, 53, 49, 37, 29, 13, 11, 1, 7, 17, 43, 0,
53, 49, 43, 31, 17, 13, 0,
59, 47, 43, 37, 29, 19, 13, 1, 11, 17, 41, 53, 0,
53, 47, 41, 23, 13, 7, 1, 19, 29, 31, 37, 49, 59, 0,
53, 47, 41, 31, 29, 11, 1, 13, 17, 23, 0,
53, 41, 37, 29, 19, 13, 7, 17, 31, 47, 0,
59, 49, 41, 31, 19, 17, 1, 7, 29, 43, 47, 0,
59, 53, 49, 41, 37, 7, 11, 13, 17, 19, 29, 47, 0,
53, 49, 43, 37, 31, 23, 17, 19, 41, 47, 0,
59, 53, 47, 41, 37, 23, 1, 11, 13, 31, 0,
47, 23, 19, 17, 13, 11, 7, 31, 59, 0,
59, 17, 13, 11, 7, 23, 29, 31, 49, 53, 0,
53, 47, 19, 1, 13, 29, 41, 43, 49, 0,
59, 29, 23, 19, 13, 7, 11, 37, 41, 47, 53, 0,
41, 31, 13, 7, 1, 43, 47, 59, 0,
49, 47, 31, 29, 23, 19, 7, 11, 13, 0,
59, 53, 41, 37, 13, 11, 23, 29, 31, 43, 0,
49, 41, 37, 31, 19, 17, 1, 7, 11, 23, 43, 59, 0,
59, 53, 47, 29, 19, 13, 11, 7, 1, 37, 0,
53, 43, 37, 23, 1, 7, 29, 31, 47, 49, 0,
49, 41, 23, 11, 13, 19, 37, 47, 53, 0,
59, 49, 41, 23, 17, 13, 11, 7, 1, 19, 31, 43, 0,
53, 49, 43, 37, 31, 29, 23, 11, 1, 19, 59, 0,
59, 43, 41, 31, 17, 13, 19, 29, 0,
53, 47, 31, 23, 13, 11, 1, 29, 0,
53, 43, 41, 29, 17, 1, 11, 23, 31, 49, 59, 0,
43, 41, 29, 23, 19, 13, 11, 47, 49, 59, 0,
59, 43, 31, 23, 1, 7, 11, 13, 29, 49, 0,
59, 49, 41, 29, 23, 17, 11, 7, 13, 47, 0,
59, 53, 49, 47, 31, 19, 7, 11, 37, 41, 0,
53, 47, 41, 37, 29, 23, 19, 1, 13, 43, 59, 0,
59, 47, 17, 13, 7, 37, 0,
59, 49, 41, 29, 19, 7, 1, 11, 23, 37, 53, 0,
53, 47, 43, 37, 1, 19, 29, 59, 0,
49, 47, 43, 41, 13, 1, 19, 53, 0,
49, 43, 29, 11, 7, 1, 41, 59, 0,
59, 43, 37, 19, 17, 7, 11, 13, 31, 49, 0,
53, 47, 31, 19, 11, 1, 13, 59, 0,
59, 53, 49, 37, 23, 19, 17, 13, 11, 7, 1, 29, 31, 43, 0,
59, 53, 29, 19, 17, 7, 1, 11, 23, 37, 43, 49, 0,
19, 1, 7, 17, 29, 37, 47, 59, 0,
49, 47, 41, 37, 23, 7, 1, 13, 19, 43, 53, 0,
59, 53, 31, 29, 7, 1, 17, 41, 43, 0,
49, 47, 43, 29, 19, 17, 11, 7, 23, 31, 0,
59, 53, 47, 43, 37, 31, 17, 13, 11, 1, 23, 41, 0,
49, 47, 31, 19, 11, 7, 17, 43, 53, 0,
59, 53, 47, 43, 41, 31, 11, 7, 1, 0,
43, 41, 37, 13, 11, 1, 23, 29, 31, 0,
47, 41, 29, 13, 1, 23, 53, 0,
53, 43, 41, 29, 17, 13, 11, 7, 1, 47, 49, 0,
31, 23, 7, 1, 17, 19, 41, 49, 59, 0,
53, 41, 37, 19, 17, 1, 11, 13, 23, 31, 59, 0,
59, 53, 31, 19, 13, 1, 23, 29, 37, 43, 49, 0,
53, 49, 47, 29, 19, 13, 7, 37, 43, 0,
47, 43, 41, 37, 19, 13, 17, 23, 31, 59, 0,
47, 13, 1, 7, 11, 19, 23, 37, 41, 43, 49, 0,
43, 41, 37, 31, 23, 13, 11, 1, 17, 47, 49, 0,
59, 47, 37, 19, 7, 17, 31, 53, 0,
53, 41, 37, 23, 19, 1, 11, 31, 0,
49, 31, 23, 17, 1, 37, 43, 53, 0,
53, 49, 43, 41, 29, 17, 13, 7, 1, 11, 31, 0,
53, 47, 43, 41, 29, 11, 7, 59, 0,
49, 47, 43, 41, 37, 29, 17, 13, 23, 0,
59, 49, 43, 31, 7, 1, 13, 29, 41, 0,
59, 49, 29, 19, 17, 11, 7, 13, 53, 0,
59, 43, 41, 37, 29, 11, 1, 17, 19, 47, 0,
59, 49, 31, 23, 17, 13, 7, 11, 53, 0,
59, 49, 43, 19, 13, 1, 17, 23, 41, 53, 0,
47, 37, 29, 23, 19, 13, 11, 1, 17, 31, 41, 59, 0,
43, 29, 17, 1, 7, 13, 37, 41, 49, 0,
53, 29, 11, 1, 13, 17, 31, 41, 47, 59, 0,
43, 31, 29, 1, 17, 47, 59, 0,
47, 23, 11, 17, 19, 29, 37, 41, 43, 0,
59, 47, 41, 37, 31, 17, 13, 11, 7, 23, 29, 49, 0,
41, 19, 17, 13, 7, 1, 29, 53, 59, 0,
53, 49, 47, 23, 11, 7, 1, 13, 19, 29, 31, 37, 0,
43, 29, 23, 19, 7, 1, 49, 0,
59, 49, 43, 37, 29, 23, 17, 13, 11, 7, 1, 31, 0,
59, 43, 37, 17, 11, 1, 7, 41, 0,
43, 31, 23, 1, 11, 13, 19, 47, 53, 59, 0,
59, 41, 37, 11, 7, 1, 19, 29, 47, 53, 0,
53, 49, 29, 7, 11, 23, 31, 59, 0,
49, 43, 37, 29, 23, 11, 13, 47, 0,
59, 47, 41, 31, 19, 1, 7, 11, 37, 49, 0,
53, 43, 41, 37, 17, 7, 11, 19, 29 };

static uint64_t upm1_stage2(uint64_t P, uint64_t rho, uint64_t n, uint32_t b1, uint64_t unityval)
{
    int w = 60;
    uint64_t d[32], six, five, pw, pgiant;
    int i, j;
    uint64_t acc;
    uint32_t b2 = 25 * b1;

    d[1] = P;
    d[2] = upm1_sqrredc(P, n, rho);
    six = upm1_mulredc(P, d[2], n, rho);       
    six = upm1_sqrredc(six, n, rho);          // P^6

    // 1, 7, 13, 19, 25, 31, 37, 43, 49
    // unnecessary powers will be mapped to scratch d[0].
    j = 1;
    while ((j + 6) < 50)
    {
        d[upm1_map[j+6]] = upm1_mulredc(d[upm1_map[j]], six, n, rho);
        j += 6;
    }

    // 11, 17, 23, 29, 35, 41, 47, 53, 59
    // unnecessary powers will be mapped to scratch d[0].
    five = upm1_sqrredc(d[2], n, rho);
    five = upm1_mulredc(five, d[1], n, rho);
    d[upm1_map[11]] = upm1_mulredc(five, six, n, rho);
    j = 11;
    while ((j + 6) < 60)
    {
        d[upm1_map[j + 6]] = upm1_mulredc(d[upm1_map[j]], six, n, rho);
        j += 6;
    }

#if 0
    b1 = 33;
    b2 = 25 * b1;
    // baby-steps, giant-steps
    printf("/* baby-steps, giant-steps for b1 = %u, b2 = %u, w = %u\n", b1, b2, w);
    i = 1;
    uint32_t p = primes[i];
    while (p < b1) p = primes[i++];
    uint32_t q = w;
    while (q < b1) q += w;
    printf("q0 = %u\n", q);
    printf("b1_20_steps[] = {\n");
    j = 0;
    while (p < b2)
    {
        if (p < q)
        {
            printf("%u, ", q - p);
            j++;
        }
        else
        {
            q += w;
            printf("0,\n");
            printf("%u, ", q - p);
            j += 2;
        }
        p = primes[i++];
    }
    printf("};\n %d entries */ \n", j);

    exit(1);
#endif

    pw = upm1_mulredc(d[upm1_map[59]], P, n, rho);      // assumes w=60
    pgiant = pw;
    i = w;
    while (i < b1)
    {
        pgiant = upm1_mulredc(pgiant, pw, n, rho);
        i += w;
    }

    acc = unityval;

    switch (b1)
    {
    case 33:

        for (i = 0; i < num_b1_33_steps; i++)
        {
            if (b1_33_steps[i] == 0)
            {
                pgiant = upm1_mulredc(pgiant, pw, n, rho);
                i++;
            }
            uint64_t tmp = upm1_mulredc(acc, 
                upm1_submod(pgiant, d[upm1_map[b1_33_steps[i]]], n), n, rho);
            if (tmp == 0) break;
            else acc = tmp;
        }
        break;
    case 100:
        
        for (i = 0; i < num_b1_100_steps; i++)
        {
            if (b1_100_steps[i] == 0)
            {
                pgiant = upm1_mulredc(pgiant, pw, n, rho);
                i++;
            }
            uint64_t tmp = upm1_mulredc(acc, 
                upm1_submod(pgiant, d[upm1_map[b1_100_steps[i]]], n), n, rho);
            if (tmp == 0) break;
            else acc = tmp;
        }
        break;
    case 333:
        
        for (i = 0; i < num_b1_333_steps; i++)
        {
            if (b1_333_steps[i] == 0)
            {
                pgiant = upm1_mulredc(pgiant, pw, n, rho);
                i++;
            }
            uint64_t tmp = upm1_mulredc(acc, 
                upm1_submod(pgiant, d[upm1_map[b1_333_steps[i]]], n), n, rho);
            if (tmp == 0) break;
            else acc = tmp;
        }
        break;
    }

    return acc;
}

static uint64_t upm1_stage2_pair(uint64_t P, uint64_t rho, uint64_t n, uint32_t b1, uint64_t unityval)
{
    int w = 60;
    uint64_t d[32], six, x12, xmid, x24, x25, x36, x60, x72, five, pw, pgiant;
    int i, j;
    uint64_t acc;
    uint32_t b2 = 25 * b1;

    // we accumulate f(vw) - f(u) where f(n) = n^2, so that
    // we can pair together primes vw+/-u
    // see: P. L. Montgomery, "Speeding the Pollard and Elliptic Curve Methods
    // of Factorization," Mathematics of Computation, Vol 48, No. 177, 1987
    // 
    // b^(n+h)^2 = b^(n^2 + 2h(n) + h^2) = (b^(n^2))*(b^(2hn))*(b^(h^2))

    // u=1, u^2=1, b^u^2 = P
    d[1] = P;
    d[2] = upm1_sqrredc(P, n, rho);
    six = upm1_mulredc(P, d[2], n, rho);
    six = upm1_sqrredc(six, n, rho);                // P^6
    x12 = upm1_sqrredc(six, n, rho);                // P^12
    x24 = upm1_sqrredc(x12, n, rho);                // P^24
    x36 = upm1_mulredc(x24, x12, n, rho);           // P^36
    x60 = upm1_mulredc(x24, x36, n, rho);           // P^60
    x72 = upm1_sqrredc(x36, n, rho);                // P^72
    five = upm1_sqrredc(d[2], n, rho);
    five = upm1_mulredc(five, d[1], n, rho);        // P^5
    x25 = upm1_mulredc(x24, d[1], n, rho);          // P^25


    // P^7^2 = P^(1+6)^2 = P^(1^2) * P^(12*1) * P^36
    // P^13^2 = P^(7+6)^2 = P^(7^2) * P^(12*7) * P^36
    // P^19^2 = P^(13+6)^2 = P^(13^2) * P^(12*13) * P^36
    // ...

    // 1, 7, 13, 19, 25, 31, 37, 43, 49
    // unnecessary powers will be mapped to scratch d[0].
    j = 1;
    xmid = x12;
    while ((j + 6) < 50)
    {
        d[upm1_map[j + 6]] = upm1_mulredc(d[upm1_map[j]], x36, n, rho);
        d[upm1_map[j + 6]] = upm1_mulredc(d[upm1_map[j + 6]], xmid, n, rho);
        xmid = upm1_mulredc(xmid, x72, n, rho);
        j += 6;
    }

    // P^11^2 = P^(5+6)^2 = P^(5^2) * P^(12*5) * P^36
    // P^17^2 = P^(11+6)^2 = P^(11^2) * P^(12*11) * P^36
    // P^23^2 = P^(17+6)^2 = P^(17^2) * P^(12*17) * P^36
    // ...

    // 11, 17, 23, 29, 35, 41, 47, 53, 59
    // unnecessary powers will be mapped to scratch d[0].
    d[upm1_map[11]] = upm1_mulredc(x25, x36, n, rho);
    d[upm1_map[11]] = upm1_mulredc(d[upm1_map[11]], x60, n, rho);
    xmid = upm1_mulredc(x60, x72, n, rho);
    j = 11;
    while ((j + 6) < 60)
    {
        d[upm1_map[j + 6]] = upm1_mulredc(d[upm1_map[j]], x36, n, rho);
        d[upm1_map[j + 6]] = upm1_mulredc(d[upm1_map[j + 6]], xmid, n, rho);
        xmid = upm1_mulredc(xmid, x72, n, rho);
        j += 6;
    }

    // P^(2w)^2, assumes w=60
    // P^(120^2) = P^(14440)
    pw = upm1_expRL(P, n, rho, unityval, 120 * 120);
    uint64_t x14400 = pw;
    uint64_t x240x120 = upm1_sqrredc(pw, n, rho);
    xmid = x240x120;
    // P^(240^2) = P^(120+120)^2 = P^(120^2) * P^(240*120) * P^(14400)
    // P^(360^2) = P^(240+120)^2 = P^(240^2) * P^(240*240) * P^(14400)
    // P^(480^2) = P^(360+120)^2 = P^(360^2) * P^(240*360) * P^(14400)
    // ...

#if 0
    // baby-steps, giant-steps
    int bi;
    int b1s[4] = { 100, 333, 666, 1000 };
    for (bi = 0; bi < 4; bi++)
    {
        b1 = b1s[bi];
        b2 = b1 * 25;
        printf("/* baby-steps, giant-steps pairing for b1 = %u, b2 = %u, w = %d\n",
            b1, b2, w);
        i = 1;
        uint32_t p = primes[i];
        while (p < b1) p = primes[i++];
        uint32_t q = 2*w;
        while (q < b1) q += 2*w;
        printf("q0 = %u\n", q);
        printf("b1_%d_pairs[] = {\n", b1);
        uint8_t pairs[60];
        for (j = 0; j < w; j++) pairs[j] = 0;
        j = 0;
        while (p < b2)
        {
            if (p < q)
            {
                printf("%u, ", q - p);
                pairs[q - p] = 1;
                j++;
                p = primes[i++];
            }
            else
            {
                // now on the other side of current giant step.
                // pair anything not currently paired.
                while ((p < b2) && ((p - q) < w))
                {
                    if (pairs[p - q] == 0)
                    {
                        printf("%u, ", (p - q));
                        j++;
                    }
                    p = primes[i++];
                }
                if (p >= b2) break;

                // next giant step, clear the pairs.
                int k;
                for (k = 0; k < w; k++) pairs[k] = 0;

                q += (2 * w);
                printf("0,\n");
                j++;
            }
        }
        printf("};\n %d entries */ \n", j);
    }


    exit(1);
#endif

    pgiant = pw;
    i = 2*w;
    while (i < b1)
    {
        pgiant = upm1_mulredc(pgiant, x14400, n, rho);
        pgiant = upm1_mulredc(pgiant, xmid, n, rho);
        xmid = upm1_mulredc(xmid, x240x120, n, rho);
        i += 2*w;
    }

    acc = unityval;
    switch (b1)
    {
    case 100:

        for (i = 0; i < num_b1_100_pairs; i++)
        {
            if (b1_100_pairs[i] == 0)
            {
                pgiant = upm1_mulredc(pgiant, x14400, n, rho);
                pgiant = upm1_mulredc(pgiant, xmid, n, rho);
                xmid = upm1_mulredc(xmid, x240x120, n, rho);
                i++;
            }

            // if we happen to pick up all factors of the input with this
            // prime pair, then the modular reduction will become 0.
            // testing for this is simple and allows us to avoid gcd == n.
            uint64_t tmp = upm1_mulredc(acc, 
                upm1_submod(pgiant, d[upm1_map[b1_100_pairs[i]]], n), n, rho);
            if (tmp == 0) break;
            else acc = tmp;
        }
        break;
    case 333:

        for (i = 0; i < num_b1_333_pairs; i++)
        {
            if (b1_333_pairs[i] == 0)
            {
                pgiant = upm1_mulredc(pgiant, x14400, n, rho);
                pgiant = upm1_mulredc(pgiant, xmid, n, rho);
                xmid = upm1_mulredc(xmid, x240x120, n, rho);
                i++;
            }
            
            uint64_t tmp = upm1_mulredc(acc, 
                upm1_submod(pgiant, d[upm1_map[b1_333_pairs[i]]], n), n, rho);
            if (tmp == 0) break;
            else acc = tmp;
        }
        break;

    case 666:

        for (i = 0; i < num_b1_666_pairs; i++)
        {
            if (b1_666_pairs[i] == 0)
            {
                pgiant = upm1_mulredc(pgiant, x14400, n, rho);
                pgiant = upm1_mulredc(pgiant, xmid, n, rho);
                xmid = upm1_mulredc(xmid, x240x120, n, rho);
                i++;
            }

            uint64_t tmp = upm1_mulredc(acc, 
                upm1_submod(pgiant, d[upm1_map[b1_666_pairs[i]]], n), n, rho);
            if (tmp == 0) break;
            else acc = tmp;
        }
        break;

    case 1000:

        for (i = 0; i < num_b1_1000_pairs; i++)
        {
            if (b1_1000_pairs[i] == 0)
            {
                pgiant = upm1_mulredc(pgiant, x14400, n, rho);
                pgiant = upm1_mulredc(pgiant, xmid, n, rho);
                xmid = upm1_mulredc(xmid, x240x120, n, rho);
                i++;
            }

            uint64_t tmp = upm1_mulredc(acc, 
                upm1_submod(pgiant, d[upm1_map[b1_1000_pairs[i]]], n), n, rho);
            if (tmp == 0) break;
            else acc = tmp;
        }
        break;
    }

    return acc;
}

static uint64_t micropm1(uint64_t n, uint32_t B1, uint32_t B2)
{
    //attempt to factor n with the elliptic curve method
    //following brent and montgomery's papers, and CP's book
    int result;
    uint64_t stg1_res, f = 0, q;
    uint64_t tmp1;
    uint64_t rho = (uint64_t)0 - upm1_multiplicative_inverse(n);

    // Let R = 2^64.  We can see R%n ≡ (R-n)%n  (mod n)
    uint64_t unityval = ((uint64_t)0 - n) % n;   // unityval == R  (mod n)

    stg1_res = upm1_stage1(rho, n, unityval, B1);
    q = upm1_mulredc(1, stg1_res, n, rho);
    result = upm1_check_factor(q-1, n, &tmp1);

    if (result == 1)
    {
        f = tmp1;
    }
    else if (B2 > B1)
    {
        uint64_t stg2acc;
        if (B1 <= 33)
            stg2acc = upm1_stage2(stg1_res, rho, n, B1, unityval);
        else
            stg2acc = upm1_stage2_pair(stg1_res, rho, n, B1, unityval);

        q = upm1_mulredc(1, stg2acc, n, rho);
        result = upm1_check_factor(q, n, &tmp1);

        if (result == 1)
        {
            f = tmp1;
        }
    }

    return f;
}

static uint64_t upm1_dispatch(uint64_t n, int targetBits, uint32_t b1)
{
    int B1 = 333;

    //upm1_generate_window_plan(33);
    //upm1_generate_window_plan(100);
    //upm1_generate_window_plan(333);
    //upm1_generate_window_plan(666);
    //upm1_generate_window_plan(1000);
    //exit(0);

    if (b1 > 0)
    {
        return micropm1(n, b1, 25 * b1);
    }
    else
    {
        if (targetBits < 50) B1 = 100;
        else B1 = 333;

        return micropm1(n, B1, 25 * B1);
    }
}

static int upm1_get_bits(uint64_t n)
{
    int i = 0;
    while (n != 0)
    {
        n >>= 1;
        i++;
    }
    return i;
}


// getfactor_upm1() returns 1 if unable to find a factor of q64,
// Otherwise it returns a factor of q64.
// 
// if the input is known to have no small factors, set is_arbitrary=0, 
// otherwise, set is_arbitrary=1 and a few curves targetting small factors
// will be run prior to the standard sequence of curves for the input size.
//  
// Prior to your first call of getfactor_upm1(), set *pran = 0  (or set it to
// some other arbitrary value); after that, don't change *pran.
// FYI: *pran is used within this file by a random number generator, and it
// holds the current value of a pseudo random sequence.  Your first assigment
// to *pran seeds the sequence, and after seeding it you don't want to
// change *pran, since that would restart the sequence.
uint64_t getfactor_upm1(uint64_t q64, uint32_t b1)
{
    if (q64 % 2 == 0)
        return 2;

    if (b1 > 0)
    {
        return upm1_dispatch(q64, 0, b1);
    }
    else
    {
        int bits = upm1_get_bits(q64);
        return upm1_dispatch(q64, bits, 0);
    }
}


